{
  "all_hints_text": "@cdce8p Just thinking out loud: can we also use a type guard to define `cached_property`? Would `mypy` pick up on that? \n> @cdce8p Just thinking out loud: can we also use a type guard to define `cached_property`? Would `mypy` pick up on that?\r\n\r\nNot completely sure what you want to do with that.\r\n\r\nOn other thing, I just saw that we don't set the `python-version` for mypy. If we do that, we probably need to do some more workarounds to tell mypy `cachedproperty` is equal to `cached_property`. Adding `TYPE_CHECKING` could work\r\n```py\r\nif sys.version_info >= (3, 8) or TYPE_CHECKING:\r\n    from functools import cached_property\r\nelse:\r\n    from astroid.decorators import cachedproperty as cached_property\r\n```\n\n",
  "base_commit": "da745538c7236028a22cdf0405f6829fcf6886bc",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/43e3dde23b5a8a985d7a4fe54c33c835768cee9c",
    "https://github.com/pylint-dev/astroid/commit/d0167fd7b1c7da8a8160f301fe90d5e91a66178e",
    "https://github.com/pylint-dev/astroid/commit/7c4c4951de3f188dcf2a0e677a1f65ae77aa0e50",
    "https://github.com/pylint-dev/astroid/commit/4c470f06a8877cfa561db5f3235af2e72c98d567",
    "https://github.com/pylint-dev/astroid/commit/94446255066690f402bccb02a14ae53065d55c58",
    "https://github.com/pylint-dev/astroid/commit/2c16141b1279d3edbfe89a4db798bdf21012d7ec",
    "https://github.com/pylint-dev/astroid/commit/f40b99fdae92bc5f0204a0e214486a5735657905",
    "https://github.com/pylint-dev/astroid/commit/603d5b9ec701ceeab1bcc25a2fc0813706401a78"
  ],
  "created_at": "2022-03-01T18:24:29Z",
  "hints_text": "@cdce8p Just thinking out loud: can we also use a type guard to define `cached_property`? Would `mypy` pick up on that? \n> @cdce8p Just thinking out loud: can we also use a type guard to define `cached_property`? Would `mypy` pick up on that?\r\n\r\nNot completely sure what you want to do with that.\r\n\r\nOn other thing, I just saw that we don't set the `python-version` for mypy. If we do that, we probably need to do some more workarounds to tell mypy `cachedproperty` is equal to `cached_property`. Adding `TYPE_CHECKING` could work\r\n```py\r\nif sys.version_info >= (3, 8) or TYPE_CHECKING:\r\n    from functools import cached_property\r\nelse:\r\n    from astroid.decorators import cachedproperty as cached_property\r\n```\n\n",
  "instance_id": "pylint-dev__astroid-1417",
  "issue_numbers": [
    1410
  ],
  "language": "python",
  "patch": "diff --git a/ChangeLog b/ChangeLog\nindex e5be140ade..ec61695daf 100644\n--- a/ChangeLog\n+++ b/ChangeLog\n@@ -9,6 +9,11 @@ Release date: TBA\n * Add new (optional) ``doc_node`` attribute to ``nodes.Module``, ``nodes.ClassDef``,\n   and ``nodes.FunctionDef``.\n \n+* Replace custom ``cachedproperty`` with ``functools.cached_property`` and deprecate it\n+  for Python 3.8+.\n+\n+  Closes #1410\n+\n \n What's New in astroid 2.10.1?\n =============================\ndiff --git a/astroid/decorators.py b/astroid/decorators.py\nindex aff91e0c89..ef2e102a83 100644\n--- a/astroid/decorators.py\n+++ b/astroid/decorators.py\n@@ -52,6 +52,8 @@ def cached(func, instance, args, kwargs):\n         return result\n \n \n+# TODO: Remove when support for 3.7 is dropped\n+# TODO: astroid 3.0 -> move class behind sys.version_info < (3, 8) guard\n class cachedproperty:\n     \"\"\"Provides a cached property equivalent to the stacking of\n     @cached and @property, but more efficient.\n@@ -70,6 +72,12 @@ class cachedproperty:\n     __slots__ = (\"wrapped\",)\n \n     def __init__(self, wrapped):\n+        if sys.version_info >= (3, 8):\n+            warnings.warn(\n+                \"cachedproperty has been deprecated and will be removed in astroid 3.0 for Python 3.8+. \"\n+                \"Use functools.cached_property instead.\",\n+                DeprecationWarning,\n+            )\n         try:\n             wrapped.__name__\n         except AttributeError as exc:\ndiff --git a/astroid/mixins.py b/astroid/mixins.py\nindex deefd59726..91c628f202 100644\n--- a/astroid/mixins.py\n+++ b/astroid/mixins.py\n@@ -18,6 +18,7 @@\n \"\"\"This module contains some mixins for the different nodes.\n \"\"\"\n import itertools\n+import sys\n from typing import TYPE_CHECKING, Optional\n \n from astroid import decorators\n@@ -26,11 +27,16 @@\n if TYPE_CHECKING:\n     from astroid import nodes\n \n+if sys.version_info >= (3, 8) or TYPE_CHECKING:\n+    from functools import cached_property\n+else:\n+    from astroid.decorators import cachedproperty as cached_property\n+\n \n class BlockRangeMixIn:\n     \"\"\"override block range\"\"\"\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def blockstart_tolineno(self):\n         return self.lineno\n \n@@ -135,7 +141,7 @@ class MultiLineBlockMixin:\n     Assign nodes, etc.\n     \"\"\"\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def _multi_line_blocks(self):\n         return tuple(getattr(self, field) for field in self._multi_line_block_fields)\n \ndiff --git a/astroid/nodes/node_classes.py b/astroid/nodes/node_classes.py\nindex a8d4c1e1b0..6214e42f37 100644\n--- a/astroid/nodes/node_classes.py\n+++ b/astroid/nodes/node_classes.py\n@@ -80,6 +80,12 @@\n     from astroid import nodes\n     from astroid.nodes import LocalsDictNodeNG\n \n+if sys.version_info >= (3, 8) or TYPE_CHECKING:\n+    # pylint: disable-next=ungrouped-imports\n+    from functools import cached_property\n+else:\n+    from astroid.decorators import cachedproperty as cached_property\n+\n \n def _is_const(value):\n     return isinstance(value, tuple(CONST_CLS))\n@@ -824,7 +830,7 @@ def _infer_name(self, frame, name):\n             return name\n         return None\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def fromlineno(self):\n         \"\"\"The first line that this node appears on in the source code.\n \n@@ -833,7 +839,7 @@ def fromlineno(self):\n         lineno = super().fromlineno\n         return max(lineno, self.parent.fromlineno or 0)\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def arguments(self):\n         \"\"\"Get all the arguments for this node, including positional only and positional and keyword\"\"\"\n         return list(itertools.chain((self.posonlyargs or ()), self.args or ()))\n@@ -2601,7 +2607,7 @@ def postinit(\n         if body is not None:\n             self.body = body\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def blockstart_tolineno(self):\n         \"\"\"The line on which the beginning of this block ends.\n \n@@ -2734,7 +2740,7 @@ def postinit(\n     See astroid/protocols.py for actual implementation.\n     \"\"\"\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def blockstart_tolineno(self):\n         \"\"\"The line on which the beginning of this block ends.\n \n@@ -3093,7 +3099,7 @@ def postinit(\n         if isinstance(self.parent, If) and self in self.parent.orelse:\n             self.is_orelse = True\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def blockstart_tolineno(self):\n         \"\"\"The line on which the beginning of this block ends.\n \n@@ -3762,7 +3768,7 @@ def _wrap_attribute(self, attr):\n             return const\n         return attr\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def _proxied(self):\n         builtins = AstroidManager().builtins_module\n         return builtins.getattr(\"slice\")[0]\n@@ -4384,7 +4390,7 @@ def postinit(\n         if orelse is not None:\n             self.orelse = orelse\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def blockstart_tolineno(self):\n         \"\"\"The line on which the beginning of this block ends.\n \n@@ -4500,7 +4506,7 @@ def postinit(\n     See astroid/protocols.py for actual implementation.\n     \"\"\"\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def blockstart_tolineno(self):\n         \"\"\"The line on which the beginning of this block ends.\n \ndiff --git a/astroid/nodes/node_ng.py b/astroid/nodes/node_ng.py\nindex 73d12a37f7..290a029403 100644\n--- a/astroid/nodes/node_ng.py\n+++ b/astroid/nodes/node_ng.py\n@@ -38,6 +38,12 @@\n else:\n     from typing_extensions import Literal\n \n+if sys.version_info >= (3, 8) or TYPE_CHECKING:\n+    # pylint: disable-next=ungrouped-imports\n+    from functools import cached_property\n+else:\n+    # pylint: disable-next=ungrouped-imports\n+    from astroid.decorators import cachedproperty as cached_property\n \n # Types for 'NodeNG.nodes_of_class()'\n T_Nodes = TypeVar(\"T_Nodes\", bound=\"NodeNG\")\n@@ -435,14 +441,14 @@ def previous_sibling(self):\n     # these are lazy because they're relatively expensive to compute for every\n     # single node, and they rarely get looked at\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def fromlineno(self) -> Optional[int]:\n         \"\"\"The first line that this node appears on in the source code.\"\"\"\n         if self.lineno is None:\n             return self._fixed_source_line()\n         return self.lineno\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def tolineno(self) -> Optional[int]:\n         \"\"\"The last line that this node appears on in the source code.\"\"\"\n         if self.end_lineno is not None:\ndiff --git a/astroid/nodes/scoped_nodes/scoped_nodes.py b/astroid/nodes/scoped_nodes/scoped_nodes.py\nindex a8dcf3549f..cdaf8c3928 100644\n--- a/astroid/nodes/scoped_nodes/scoped_nodes.py\n+++ b/astroid/nodes/scoped_nodes/scoped_nodes.py\n@@ -52,7 +52,7 @@\n import sys\n import typing\n import warnings\n-from typing import Dict, List, Optional, Set, TypeVar, Union, overload\n+from typing import TYPE_CHECKING, Dict, List, Optional, Set, TypeVar, Union, overload\n \n from astroid import bases\n from astroid import decorators as decorators_mod\n@@ -93,6 +93,12 @@\n else:\n     from typing_extensions import Literal\n \n+if sys.version_info >= (3, 8) or TYPE_CHECKING:\n+    from functools import cached_property\n+else:\n+    # pylint: disable-next=ungrouped-imports\n+    from astroid.decorators import cachedproperty as cached_property\n+\n \n ITER_METHODS = (\"__iter__\", \"__getitem__\")\n EXCEPTION_BASE_CLASSES = frozenset({\"Exception\", \"BaseException\"})\n@@ -1611,7 +1617,7 @@ def postinit(\n         self.position = position\n         self.doc_node = doc_node\n \n-    @decorators_mod.cachedproperty\n+    @cached_property\n     def extra_decorators(self) -> List[node_classes.Call]:\n         \"\"\"The extra decorators that this function can have.\n \n@@ -1652,7 +1658,7 @@ def extra_decorators(self) -> List[node_classes.Call]:\n                             decorators.append(assign.value)\n         return decorators\n \n-    @decorators_mod.cachedproperty\n+    @cached_property\n     def type(\n         self,\n     ):  # pylint: disable=invalid-overridden-method,too-many-return-statements\n@@ -1726,7 +1732,7 @@ def type(\n                 pass\n         return type_name\n \n-    @decorators_mod.cachedproperty\n+    @cached_property\n     def fromlineno(self) -> Optional[int]:\n         \"\"\"The first line that this node appears on in the source code.\"\"\"\n         # lineno is the line number of the first decorator, we want the def\n@@ -1739,7 +1745,7 @@ def fromlineno(self) -> Optional[int]:\n \n         return lineno\n \n-    @decorators_mod.cachedproperty\n+    @cached_property\n     def blockstart_tolineno(self):\n         \"\"\"The line on which the beginning of this block ends.\n \n@@ -2337,7 +2343,7 @@ def _newstyle_impl(self, context=None):\n         doc=(\"Whether this is a new style class or not\\n\\n\" \":type: bool or None\"),\n     )\n \n-    @decorators_mod.cachedproperty\n+    @cached_property\n     def fromlineno(self) -> Optional[int]:\n         \"\"\"The first line that this node appears on in the source code.\"\"\"\n         if not PY38_PLUS:\n@@ -2352,7 +2358,7 @@ def fromlineno(self) -> Optional[int]:\n             return lineno\n         return super().fromlineno\n \n-    @decorators_mod.cachedproperty\n+    @cached_property\n     def blockstart_tolineno(self):\n         \"\"\"The line on which the beginning of this block ends.\n \ndiff --git a/astroid/objects.py b/astroid/objects.py\nindex 76ade71deb..56fbcd7a2d 100644\n--- a/astroid/objects.py\n+++ b/astroid/objects.py\n@@ -22,8 +22,10 @@\n     Call(func=Name('frozenset'), args=Tuple(...))\n \"\"\"\n \n+import sys\n+from typing import TYPE_CHECKING\n \n-from astroid import bases, decorators, util\n+from astroid import bases, util\n from astroid.exceptions import (\n     AttributeInferenceError,\n     InferenceError,\n@@ -35,6 +37,11 @@\n \n objectmodel = util.lazy_import(\"interpreter.objectmodel\")\n \n+if sys.version_info >= (3, 8) or TYPE_CHECKING:\n+    from functools import cached_property\n+else:\n+    from astroid.decorators import cachedproperty as cached_property\n+\n \n class FrozenSet(node_classes.BaseContainer):\n     \"\"\"class representing a FrozenSet composite node\"\"\"\n@@ -45,7 +52,7 @@ def pytype(self):\n     def _infer(self, context=None):\n         yield self\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def _proxied(self):  # pylint: disable=method-hidden\n         ast_builtins = AstroidManager().builtins_module\n         return ast_builtins.getattr(\"frozenset\")[0]\n@@ -114,7 +121,7 @@ def super_mro(self):\n         index = mro.index(self.mro_pointer)\n         return mro[index + 1 :]\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def _proxied(self):\n         ast_builtins = AstroidManager().builtins_module\n         return ast_builtins.getattr(\"super\")[0]\n@@ -218,7 +225,7 @@ class ExceptionInstance(bases.Instance):\n     the case of .args.\n     \"\"\"\n \n-    @decorators.cachedproperty\n+    @cached_property\n     def special_attributes(self):\n         qname = self.qname()\n         instance = objectmodel.BUILTIN_EXCEPTIONS.get(\n",
  "problem_statement": "Replace `cachedproperty` with `functools.cached_property` (>= 3.8)\nI thought about this PR recently again. Typing `cachedproperty` might not work, but it can be replaced with `functools.cached_property`. We only need to `sys` guard it for `< 3.8`. This should work\r\n```py\r\nif sys.version_info >= (3, 8):\r\n    from functools import cached_property\r\nelse:\r\n    from astroid.decorators import cachedproperty as cached_property\r\n```\r\n\r\nAdditionally, the deprecation warning can be limited to `>= 3.8`.\r\n\r\n_Originally posted by @cdce8p in https://github.com/PyCQA/astroid/issues/1243#issuecomment-1052834322_\n",
  "pull_number": 1417,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/unittest_decorators.py b/tests/unittest_decorators.py\nindex 4672f870a6..0700f570de 100644\n--- a/tests/unittest_decorators.py\n+++ b/tests/unittest_decorators.py\n@@ -1,7 +1,8 @@\n import pytest\n from _pytest.recwarn import WarningsRecorder\n \n-from astroid.decorators import deprecate_default_argument_values\n+from astroid.const import PY38_PLUS\n+from astroid.decorators import cachedproperty, deprecate_default_argument_values\n \n \n class SomeClass:\n@@ -97,3 +98,18 @@ def test_deprecated_default_argument_values_ok(recwarn: WarningsRecorder) -> Non\n         instance = SomeClass(name=\"some_name\")\n         instance.func(name=\"\", var=42)\n         assert len(recwarn) == 0\n+\n+\n+@pytest.mark.skipif(not PY38_PLUS, reason=\"Requires Python 3.8 or higher\")\n+def test_deprecation_warning_on_cachedproperty() -> None:\n+    \"\"\"Check the DeprecationWarning on cachedproperty.\"\"\"\n+\n+    with pytest.warns(DeprecationWarning) as records:\n+\n+        class MyClass:  # pylint: disable=unused-variable\n+            @cachedproperty\n+            def my_property(self):\n+                return 1\n+\n+        assert len(records) == 1\n+        assert \"functools.cached_property\" in records[0].message.args[0]\n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/da745538c7236028a22cdf0405f6829fcf6886bc"
}