{
  "all_hints_text": "\n\n",
  "base_commit": "39c2a9805970ca57093d32bbaf0e6a63e05041d8",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/a4b1d5b529aa73f681a8ae5eb77a8f79c534e68b",
    "https://github.com/pylint-dev/astroid/commit/5ab5949077261fef86591690dd617b9bb1d7772f",
    "https://github.com/pylint-dev/astroid/commit/c9cc6a67c05bd74da63b813f7fa01dc757d18193",
    "https://github.com/pylint-dev/astroid/commit/dd10dc1766a10413ec05c9311c90ef4efab2a27b",
    "https://github.com/pylint-dev/astroid/commit/59ad5cdda1d7d050490efdc51ba536bd443dd229",
    "https://github.com/pylint-dev/astroid/commit/460fab03b4128997fcb34e70a2ce50cbf03fe83a"
  ],
  "created_at": "2021-10-03T15:58:07Z",
  "hints_text": "\n\n",
  "instance_id": "pylint-dev__astroid-1196",
  "issue_numbers": [
    1195
  ],
  "language": "python",
  "patch": "diff --git a/ChangeLog b/ChangeLog\nindex c3b3e6b90b..24a7d49bfc 100644\n--- a/ChangeLog\n+++ b/ChangeLog\n@@ -55,6 +55,10 @@ Release date: TBA\n * Fix test for Python ``3.11``. In some instances ``err.__traceback__`` will\n   be uninferable now.\n \n+* Infer the ``DictUnpack`` value for ``Dict.getitem`` calls.\n+\n+  Closes #1195\n+\n What's New in astroid 2.11.6?\n =============================\n Release date: TBA\ndiff --git a/astroid/nodes/node_classes.py b/astroid/nodes/node_classes.py\nindex 11136f8c77..c97be2dfba 100644\n--- a/astroid/nodes/node_classes.py\n+++ b/astroid/nodes/node_classes.py\n@@ -2346,24 +2346,33 @@ def itered(self):\n         \"\"\"\n         return [key for (key, _) in self.items]\n \n-    def getitem(self, index, context=None):\n+    def getitem(\n+        self, index: Const | Slice, context: InferenceContext | None = None\n+    ) -> NodeNG:\n         \"\"\"Get an item from this node.\n \n         :param index: The node to use as a subscript index.\n-        :type index: Const or Slice\n \n         :raises AstroidTypeError: When the given index cannot be used as a\n             subscript index, or if this node is not subscriptable.\n         :raises AstroidIndexError: If the given index does not exist in the\n             dictionary.\n         \"\"\"\n+        # pylint: disable-next=import-outside-toplevel; circular import\n+        from astroid.helpers import safe_infer\n+\n         for key, value in self.items:\n             # TODO(cpopa): no support for overriding yet, {1:2, **{1: 3}}.\n             if isinstance(key, DictUnpack):\n+                inferred_value = safe_infer(value, context)\n+                if not isinstance(inferred_value, Dict):\n+                    continue\n+\n                 try:\n-                    return value.getitem(index, context)\n+                    return inferred_value.getitem(index, context)\n                 except (AstroidTypeError, AstroidIndexError):\n                     continue\n+\n             for inferredkey in key.infer(context):\n                 if inferredkey is util.Uninferable:\n                     continue\n",
  "problem_statement": "getitem does not infer the actual unpacked value\nWhen trying to call `Dict.getitem()` on a context where we have a dict unpacking of anything beside a real dict, astroid currently raises an `AttributeError: 'getitem'`, which has 2 problems:\r\n\r\n- The object might be a reference against something constant, this pattern is usually seen when we have different sets of dicts that extend each other, and all of their values are inferrable. \r\n- We can have something that is uninferable, but in that case instead of an `AttributeError` I think it makes sense to raise the usual `AstroidIndexError` which is supposed to be already handled by the downstream.\r\n\r\n\r\nHere is a short reproducer;\r\n\r\n```py\r\nfrom astroid import parse\r\n\r\n\r\nsource = \"\"\"\r\nX = {\r\n    'A': 'B'\r\n}\r\n\r\nY = {\r\n    **X\r\n}\r\n\r\nKEY = 'A'\r\n\"\"\"\r\n\r\ntree = parse(source)\r\n\r\nfirst_dict = tree.body[0].value\r\nsecond_dict = tree.body[1].value\r\nkey = tree.body[2].value\r\n\r\nprint(f'{first_dict.getitem(key).value = }')\r\nprint(f'{second_dict.getitem(key).value = }')\r\n\r\n\r\n```\r\n\r\nThe current output;\r\n\r\n```\r\n $ python t1.py                                                                                                 3ms\r\nfirst_dict.getitem(key).value = 'B'\r\nTraceback (most recent call last):\r\n  File \"/home/isidentical/projects/astroid/t1.py\", line 23, in <module>\r\n    print(f'{second_dict.getitem(key).value = }')\r\n  File \"/home/isidentical/projects/astroid/astroid/nodes/node_classes.py\", line 2254, in getitem\r\n    return value.getitem(index, context)\r\nAttributeError: 'Name' object has no attribute 'getitem'\r\n```\r\n\r\nExpeceted output;\r\n```\r\n $ python t1.py                                                                                                 4ms\r\nfirst_dict.getitem(key).value = 'B'\r\nsecond_dict.getitem(key).value = 'B'\r\n\r\n```\r\n\n",
  "pull_number": 1196,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/unittest_python3.py b/tests/unittest_python3.py\nindex 9f60833e8e..bf0a0b33da 100644\n--- a/tests/unittest_python3.py\n+++ b/tests/unittest_python3.py\n@@ -5,7 +5,9 @@\n import unittest\n from textwrap import dedent\n \n-from astroid import nodes\n+import pytest\n+\n+from astroid import exceptions, nodes\n from astroid.builder import AstroidBuilder, extract_node\n from astroid.test_utils import require_version\n \n@@ -285,6 +287,33 @@ def test_unpacking_in_dict_getitem(self) -> None:\n             self.assertIsInstance(value, nodes.Const)\n             self.assertEqual(value.value, expected)\n \n+    @staticmethod\n+    def test_unpacking_in_dict_getitem_with_ref() -> None:\n+        node = extract_node(\n+            \"\"\"\n+        a = {1: 2}\n+        {**a, 2: 3}  #@\n+        \"\"\"\n+        )\n+        assert isinstance(node, nodes.Dict)\n+\n+        for key, expected in ((1, 2), (2, 3)):\n+            value = node.getitem(nodes.Const(key))\n+            assert isinstance(value, nodes.Const)\n+            assert value.value == expected\n+\n+    @staticmethod\n+    def test_unpacking_in_dict_getitem_uninferable() -> None:\n+        node = extract_node(\"{**a, 2: 3}\")\n+        assert isinstance(node, nodes.Dict)\n+\n+        with pytest.raises(exceptions.AstroidIndexError):\n+            node.getitem(nodes.Const(1))\n+\n+        value = node.getitem(nodes.Const(2))\n+        assert isinstance(value, nodes.Const)\n+        assert value.value == 3\n+\n     def test_format_string(self) -> None:\n         code = \"f'{greetings} {person}'\"\n         node = extract_node(code)\n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/39c2a9805970ca57093d32bbaf0e6a63e05041d8"
}