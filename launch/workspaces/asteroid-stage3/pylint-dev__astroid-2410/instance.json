{
  "all_hints_text": "I made draft pull requests with the two possible fixes, #2410 and #2411\n\n",
  "base_commit": "7a3b482b9673243d2ccc895672eb1e452f5daa82",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/a41866325f31ffe6f54c58d69b0eb875c971e65f",
    "https://github.com/pylint-dev/astroid/commit/1bf2c1a4c4f4488eeef449782eb44b0990004c0d",
    "https://github.com/pylint-dev/astroid/commit/9159aff0dd9de0dcbd0a84e340fd0c1183bb33aa",
    "https://github.com/pylint-dev/astroid/commit/d9fd7cc840d898363e594030dab614c08ab93e6e",
    "https://github.com/pylint-dev/astroid/commit/404e6c4c2f1cbc63628c017bde92e3f0caddcd79"
  ],
  "created_at": "2024-04-08T04:33:42Z",
  "hints_text": "\n\n",
  "instance_id": "pylint-dev__astroid-2410",
  "issue_numbers": [
    2409
  ],
  "language": "python",
  "patch": "diff --git a/ChangeLog b/ChangeLog\nindex c6119847bc..5e4f68f3aa 100644\n--- a/ChangeLog\n+++ b/ChangeLog\n@@ -19,6 +19,13 @@ Release date: TBA\n \n   Refs pylint-dev/pylint#9442\n \n+* Make ``astroid.interpreter._import.util.is_namespace`` only consider modules\n+  using a loader set to ``NamespaceLoader`` or ``None`` as namespaces.\n+  This fixes a problem that ``six.moves`` brain was not effective if ``six.moves``\n+  was already imported.\n+\n+  Closes #1107\n+\n \n What's New in astroid 3.1.1?\n ============================\ndiff --git a/astroid/interpreter/_import/util.py b/astroid/interpreter/_import/util.py\nindex a8af9ec6ae..511ec4f977 100644\n--- a/astroid/interpreter/_import/util.py\n+++ b/astroid/interpreter/_import/util.py\n@@ -12,6 +12,11 @@\n \n from astroid.const import IS_PYPY\n \n+if sys.version_info >= (3, 11):\n+    from importlib.machinery import NamespaceLoader\n+else:\n+    from importlib._bootstrap_external import _NamespaceLoader as NamespaceLoader\n+\n \n @lru_cache(maxsize=4096)\n def is_namespace(modname: str) -> bool:\n@@ -101,4 +106,7 @@ def is_namespace(modname: str) -> bool:\n         found_spec is not None\n         and found_spec.submodule_search_locations is not None\n         and found_spec.origin is None\n+        and (\n+            found_spec.loader is None or isinstance(found_spec.loader, NamespaceLoader)\n+        )\n     )\n",
  "problem_statement": "`six.moves` brain is not effective when `six.moves` was already imported in interpreter running astroid\nInference of `six.moves` attributes differs when `six.moves` was already imported or not.\r\n\r\n### Steps to reproduce\r\n\r\n```py\r\nimport astroid.builder\r\n# import six.moves   #   <<< un-comment this line to see the problem\r\n\r\nprint(\r\n    next(\r\n        astroid.builder.extract_node(\r\n            \"\"\"\r\nfrom six.moves import StringIO\r\nStringIO  #@\r\n\"\"\"\r\n        ).infer()\r\n    ).qname()\r\n)\r\n```\r\n\r\n### Current behavior\r\n\r\nWhen `six.moves` is not imported, the node is inferred as `_io.StringIO`, which is expected, but when `six.moves` is imported, the node is not inferred correctly. The reproduction snippet prints `six.moves`.\r\n\r\n### Expected behavior\r\n\r\nThis should not depend on the imported modules, the inferred value should be `_io.StringIO` in all cases.\r\n\r\n### More information\r\n\r\n`six.moves` is a dynamic module with a custom loader:\r\n\r\n```py\r\n>>> import six.moves\r\n>>> six.moves.__spec__\r\nModuleSpec(name='six.moves', loader=<six._SixMetaPathImporter object at 0x7fa3b2bad9d0>, submodule_search_locations=[])\r\n```\r\n\r\nWhen building the ast for a module, astroid tries various \"spec finders\" to find a module spec here:\r\n\r\nhttps://github.com/pylint-dev/astroid/blob/396f01a15d1cb0351b33654acdeedde64f537a0c/astroid/interpreter/_import/spec.py#L377-L379\r\n\r\none is `ExplicitNamespacePackageFinder` which looks in `sys.modules`:\r\n\r\nhttps://github.com/pylint-dev/astroid/blob/396f01a15d1cb0351b33654acdeedde64f537a0c/astroid/interpreter/_import/spec.py#L231\r\n\r\nthis is where the behavior differs.\r\n\r\n`util.is_namespace(\"six.moves\")` returns False, so an empty module is returned, as we can see, the module is empty:\r\n\r\n```py\r\n>>> import astroid\r\n>>> import six.moves\r\n>>> astroid.MANAGER.ast_from_module_name('six.moves').as_string()\r\n'\\n\\n'\r\n```\r\n\r\nBut in the \"it works\" case, when `six.moves` was not imported, the module content is present:\r\n\r\n```py\r\n>>> import astroid\r\n>>> astroid.MANAGER.ast_from_module_name('six.moves').as_string()[:100]\r\n'import _io\\ncStringIO = _io.StringIO\\nfilter = filter\\nfrom itertools import filterfalse\\ninput = input\\n'\r\n```\r\n\r\nnote that this is not the actual module source code, this was built dynamically by the failed import hooks from the brain here:\r\n\r\nhttps://github.com/pylint-dev/astroid/blob/9aa9bfd7466a62a61affdd623c40265617d1d559/astroid/brain/brain_six.py#L230\r\n\r\n\r\n#### Suggested fixes\r\n\r\nI see two possibilities to fix this:\r\n\r\nThe first option is to consider that `astroid.interpreter._import.util.is_namespace` is wrong when evaluating `six.moves` as a namespace.\r\n\r\nHonestly, I don't fully understand what is the definition of a \"namespace\" here. I guess this is an empty module with submodules search path, so one fix might be to change the condition `found_spec.submodule_search_locations is not None` into a \"simpler\" `found_spec.submodule_search_locations` here:\r\n\r\nhttps://github.com/pylint-dev/astroid/blob/de942f3076ff3d1263b1e598c89a6bb31e4a27ea/astroid/interpreter/_import/util.py#L102\r\n\r\nin the case of `six.moves`, `found_spec.submodule_search_locations` is `[]`. I *think* that what's the most important in the distinction between a namespace and a \"regular\" module here is that a namespace comes with submodules, so if it's `[]` or `None` it might be equivalent (but once again, I don't really understand this).\r\n\r\nThe second option is that before deciding that a module is \"just an empty namespace\", give failed import hooks a chance to populate the module with something. This change would be simply to try all the `self._failed_import_hooks` before `_build_namespace_module` in \r\n\r\nhttps://github.com/pylint-dev/astroid/blob/de942f3076ff3d1263b1e598c89a6bb31e4a27ea/astroid/manager.py#L247-L250\r\n\r\nthis branch would become:\r\n\r\n```py\r\n            elif found_spec.type == spec.ModuleType.PY_NAMESPACE:\r\n                # before returning an empty namespace module, allow a fail import hook\r\n                # to return a dynamic module instead.\r\n                for hook in self._failed_import_hooks:\r\n                    try:\r\n                        return hook(modname)\r\n                    except AstroidBuildingError:\r\n                        pass\r\n                return self._build_namespace_module(\r\n                    modname, found_spec.submodule_search_locations or []\r\n                )\r\n```\r\n\r\n### `python -c \"from astroid import __pkginfo__; print(__pkginfo__.version)\"` output\r\n\r\n`3.2.0-dev0`, this is on current git version, de942f30\r\n\n",
  "pull_number": 2410,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/brain/test_six.py b/tests/brain/test_six.py\nindex c7c9db7620..45a40e552a 100644\n--- a/tests/brain/test_six.py\n+++ b/tests/brain/test_six.py\n@@ -29,6 +29,8 @@ def test_attribute_access(self) -> None:\n         six.moves.urllib_parse #@\n         six.moves.urllib_error #@\n         six.moves.urllib.request #@\n+        from six.moves import StringIO\n+        StringIO #@\n         \"\"\"\n         )\n         assert isinstance(ast_nodes, list)\n@@ -64,6 +66,18 @@ def test_attribute_access(self) -> None:\n         self.assertIsInstance(urlretrieve, nodes.FunctionDef)\n         self.assertEqual(urlretrieve.qname(), \"urllib.request.urlretrieve\")\n \n+        StringIO = next(ast_nodes[4].infer())\n+        self.assertIsInstance(StringIO, nodes.ClassDef)\n+        self.assertEqual(StringIO.qname(), \"_io.StringIO\")\n+        self.assertTrue(StringIO.callable())\n+\n+    def test_attribute_access_with_six_moves_imported(self) -> None:\n+        astroid.MANAGER.clear_cache()\n+        astroid.MANAGER._mod_file_cache.clear()\n+        import six.moves  # type: ignore[import]  # pylint: disable=import-outside-toplevel,unused-import,redefined-outer-name\n+\n+        self.test_attribute_access()\n+\n     def test_from_imports(self) -> None:\n         ast_node = builder.extract_node(\n             \"\"\"\n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/7a3b482b9673243d2ccc895672eb1e452f5daa82"
}