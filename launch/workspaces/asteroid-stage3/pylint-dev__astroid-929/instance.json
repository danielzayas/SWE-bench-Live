{
  "all_hints_text": "\n\n",
  "base_commit": "efc5be48e8294cea6c5335a3ad0821fa920fd1e6",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/6b609bea4ae523192a9d63c508ea6583579411d4",
    "https://github.com/pylint-dev/astroid/commit/334ce364d6cb26a0667624a8d36954f7ca74e48e"
  ],
  "created_at": "2021-04-06T04:58:09Z",
  "hints_text": "\n\n",
  "instance_id": "pylint-dev__astroid-929",
  "issue_numbers": [
    920
  ],
  "language": "python",
  "patch": "diff --git a/ChangeLog b/ChangeLog\nindex 9d7b945fde..80ec58bed1 100644\n--- a/ChangeLog\n+++ b/ChangeLog\n@@ -10,6 +10,11 @@ Release Date: TBA\n \n   Closes #932\n \n+* Update `infer_named_tuple` brain to reject namedtuple definitions\n+  that would raise ValueError\n+\n+  Closes #920\n+\n * Do not set instance attributes on builtin object()\n \n  Closes #945\ndiff --git a/astroid/brain/brain_namedtuple_enum.py b/astroid/brain/brain_namedtuple_enum.py\nindex 9a9cc98981..a9f1594926 100644\n--- a/astroid/brain/brain_namedtuple_enum.py\n+++ b/astroid/brain/brain_namedtuple_enum.py\n@@ -28,6 +28,8 @@\n \n from astroid import (\n     MANAGER,\n+    AstroidTypeError,\n+    AstroidValueError,\n     InferenceError,\n     UseInferenceDefault,\n     arguments,\n@@ -130,6 +132,11 @@ def infer_func_form(node, base_type, context=None, enum=False):\n     except (AttributeError, exceptions.InferenceError) as exc:\n         raise UseInferenceDefault from exc\n \n+    if not enum:\n+        # namedtuple maps sys.intern(str()) over over field_names\n+        attributes = [str(attr) for attr in attributes]\n+        # XXX this should succeed *unless* __str__/__repr__ is incorrect or throws\n+        # in which case we should not have inferred these values and raised earlier\n     attributes = [attr for attr in attributes if \" \" not in attr]\n \n     # If we can't infer the name of the class, don't crash, up to this point\n@@ -185,8 +192,12 @@ def infer_named_tuple(node, context=None):\n     except InferenceError:\n         rename = False\n \n-    if rename:\n-        attributes = _get_renamed_namedtuple_attributes(attributes)\n+    try:\n+        attributes = _check_namedtuple_attributes(name, attributes, rename)\n+    except AstroidTypeError as exc:\n+        raise UseInferenceDefault(\"TypeError: \" + str(exc)) from exc\n+    except AstroidValueError as exc:\n+        raise UseInferenceDefault(\"ValueError: \" + str(exc)) from exc\n \n     replace_args = \", \".join(f\"{arg}=None\" for arg in attributes)\n     field_def = (\n@@ -247,6 +258,39 @@ def _get_renamed_namedtuple_attributes(field_names):\n     return tuple(names)\n \n \n+def _check_namedtuple_attributes(typename, attributes, rename=False):\n+    attributes = tuple(attributes)\n+    if rename:\n+        attributes = _get_renamed_namedtuple_attributes(attributes)\n+\n+    # The following snippet is derived from the CPython Lib/collections/__init__.py sources\n+    # <snippet>\n+    for name in (typename,) + attributes:\n+        if not isinstance(name, str):\n+            raise AstroidTypeError(\"Type names and field names must be strings\")\n+        if not name.isidentifier():\n+            raise AstroidValueError(\n+                \"Type names and field names must be valid\" + f\"identifiers: {name!r}\"\n+            )\n+        if keyword.iskeyword(name):\n+            raise AstroidValueError(\n+                f\"Type names and field names cannot be a keyword: {name!r}\"\n+            )\n+\n+    seen = set()\n+    for name in attributes:\n+        if name.startswith(\"_\") and not rename:\n+            raise AstroidValueError(\n+                f\"Field names cannot start with an underscore: {name!r}\"\n+            )\n+        if name in seen:\n+            raise AstroidValueError(f\"Encountered duplicate field name: {name!r}\")\n+        seen.add(name)\n+    # </snippet>\n+\n+    return attributes\n+\n+\n def infer_enum(node, context=None):\n     \"\"\"Specific inference function for enum Call node.\"\"\"\n     enum_meta = extract_node(\ndiff --git a/astroid/exceptions.py b/astroid/exceptions.py\nindex df33b571c5..a20bf47aa6 100644\n--- a/astroid/exceptions.py\n+++ b/astroid/exceptions.py\n@@ -214,6 +214,10 @@ class AstroidTypeError(AstroidError):\n     \"\"\"Raised when a TypeError would be expected in Python code.\"\"\"\n \n \n+class AstroidValueError(AstroidError):\n+    \"\"\"Raised when a ValueError would be expected in Python code.\"\"\"\n+\n+\n class InferenceOverwriteError(AstroidError):\n     \"\"\"Raised when an inference tip is overwritten\n \n",
  "problem_statement": "Crash when using keyword as namedtuple field-name.\n### Steps to reproduce\r\n1. pylint [keyword_field.txt](https://github.com/PyCQA/astroid/files/6135317/keyword_field.txt)\r\n\r\n\r\n### Current behavior\r\n```\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3/dist-packages/astroid/__init__.py\", line 93, in _inference_tip_cached\r\n    return iter(_cache[func, node])\r\nKeyError: (<function infer_named_tuple at 0x7f77f1a118b0>, <Call l.2 at 0x7f77f15e6910>)\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3/dist-packages/astroid/builder.py\", line 168, in _data_build\r\n    node, parser_module = _parse_string(data, type_comments=True)\r\n  File \"/usr/lib/python3/dist-packages/astroid/builder.py\", line 445, in _parse_string\r\n    parsed = parser_module.parse(data + \"\\n\", type_comments=type_comments)\r\n  File \"/usr/lib/python3/dist-packages/astroid/_ast.py\", line 48, in parse\r\n    return parse_func(string)\r\n  File \"/usr/lib/python3.8/ast.py\", line 47, in parse\r\n    return compile(source, filename, mode, flags,\r\n  File \"<unknown>\", line 10\r\n    def _replace(self, was=None, is=None):\r\n                                 ^\r\nSyntaxError: invalid syntax\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/usr/bin/pylint\", line 11, in <module>\r\n    load_entry_point('pylint==2.5.3', 'console_scripts', 'pylint')()\r\n  File \"/usr/lib/python3/dist-packages/pylint/__init__.py\", line 22, in run_pylint\r\n    PylintRun(sys.argv[1:])\r\n  File \"/usr/lib/python3/dist-packages/pylint/lint/run.py\", line 344, in __init__\r\n    linter.check(args)\r\n  File \"/usr/lib/python3/dist-packages/pylint/lint/pylinter.py\", line 870, in check\r\n    self._check_files(\r\n  File \"/usr/lib/python3/dist-packages/pylint/lint/pylinter.py\", line 904, in _check_files\r\n    self._check_file(get_ast, check_astroid_module, name, filepath, modname)\r\n  File \"/usr/lib/python3/dist-packages/pylint/lint/pylinter.py\", line 930, in _check_file\r\n    check_astroid_module(ast_node)\r\n  File \"/usr/lib/python3/dist-packages/pylint/lint/pylinter.py\", line 1062, in check_astroid_module\r\n    retval = self._check_astroid_module(\r\n  File \"/usr/lib/python3/dist-packages/pylint/lint/pylinter.py\", line 1107, in _check_astroid_module\r\n    walker.walk(ast_node)\r\n  File \"/usr/lib/python3/dist-packages/pylint/utils/ast_walker.py\", line 75, in walk\r\n    self.walk(child)\r\n  File \"/usr/lib/python3/dist-packages/pylint/utils/ast_walker.py\", line 75, in walk\r\n    self.walk(child)\r\n  File \"/usr/lib/python3/dist-packages/pylint/utils/ast_walker.py\", line 72, in walk\r\n    callback(astroid)\r\n  File \"/usr/lib/python3/dist-packages/pylint/checkers/base.py\", line 1971, in visit_assignname\r\n    if isinstance(utils.safe_infer(assign_type.value), astroid.ClassDef):\r\n  File \"/usr/lib/python3/dist-packages/pylint/checkers/utils.py\", line 1117, in safe_infer\r\n    infer_gen = node.infer(context=context)\r\n  File \"/usr/lib/python3/dist-packages/astroid/node_classes.py\", line 357, in infer\r\n    return self._explicit_inference(self, context, **kwargs)\r\n  File \"/usr/lib/python3/dist-packages/astroid/__init__.py\", line 95, in _inference_tip_cached\r\n    result = func(*args, **kwargs)\r\n  File \"/usr/lib/python3/dist-packages/astroid/brain/brain_namedtuple_enum.py\", line 193, in infer_named_tuple\r\n    fake = AstroidBuilder(MANAGER).string_build(\r\n  File \"/usr/lib/python3/dist-packages/astroid/builder.py\", line 142, in string_build\r\n    module = self._data_build(data, modname, path)\r\n  File \"/usr/lib/python3/dist-packages/astroid/builder.py\", line 170, in _data_build\r\n    raise exceptions.AstroidSyntaxError(\r\nastroid.exceptions.AstroidSyntaxError: Parsing Python code failed:\r\ninvalid syntax (<unknown>, line 10)\r\n```\r\n\r\n### Expected behavior\r\nSince this is a Python syntax error, something like\r\n```\r\nkeyword_field.txt:2:21 E0001:type names and field names cannot be a keyword: 'is'\r\nor maybe just\r\nkeyword_field.txt:6:9: E0001: invalid syntax (<unknown>, line 6) (syntax-error)\r\n```\r\n\r\n### Output of pylint --version:\r\npylint 2.5.3\r\nastroid 2.4.2\r\nPython 3.8.6 (default, Jan 27 2021, 15:42:20) \r\n[GCC 10.2.0]\r\n\n",
  "pull_number": 929,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/unittest_brain.py b/tests/unittest_brain.py\nindex 0e8c591198..6f1c64ab66 100644\n--- a/tests/unittest_brain.py\n+++ b/tests/unittest_brain.py\n@@ -350,6 +350,99 @@ def test_invalid_label_does_not_crash_inference(self):\n         assert \"b\" not in inferred.locals\n         assert \"c\" not in inferred.locals\n \n+    def test_no_rename_duplicates_does_not_crash_inference(self):\n+        node = builder.extract_node(\n+            \"\"\"\n+        from collections import namedtuple\n+        Tuple = namedtuple(\"Tuple\", \"abc abc\")\n+        Tuple #@\n+        \"\"\"\n+        )\n+        inferred = next(node.infer())\n+        self.assertIs(util.Uninferable, inferred)  # would raise ValueError\n+\n+    def test_no_rename_keywords_does_not_crash_inference(self):\n+        node = builder.extract_node(\n+            \"\"\"\n+        from collections import namedtuple\n+        Tuple = namedtuple(\"Tuple\", \"abc def\")\n+        Tuple #@\n+        \"\"\"\n+        )\n+        inferred = next(node.infer())\n+        self.assertIs(util.Uninferable, inferred)  # would raise ValueError\n+\n+    def test_no_rename_nonident_does_not_crash_inference(self):\n+        node = builder.extract_node(\n+            \"\"\"\n+        from collections import namedtuple\n+        Tuple = namedtuple(\"Tuple\", \"123 456\")\n+        Tuple #@\n+        \"\"\"\n+        )\n+        inferred = next(node.infer())\n+        self.assertIs(util.Uninferable, inferred)  # would raise ValueError\n+\n+    def test_no_rename_underscore_does_not_crash_inference(self):\n+        node = builder.extract_node(\n+            \"\"\"\n+        from collections import namedtuple\n+        Tuple = namedtuple(\"Tuple\", \"_1\")\n+        Tuple #@\n+        \"\"\"\n+        )\n+        inferred = next(node.infer())\n+        self.assertIs(util.Uninferable, inferred)  # would raise ValueError\n+\n+    def test_invalid_typename_does_not_crash_inference(self):\n+        node = builder.extract_node(\n+            \"\"\"\n+        from collections import namedtuple\n+        Tuple = namedtuple(\"123\", \"abc\")\n+        Tuple #@\n+        \"\"\"\n+        )\n+        inferred = next(node.infer())\n+        self.assertIs(util.Uninferable, inferred)  # would raise ValueError\n+\n+    def test_keyword_typename_does_not_crash_inference(self):\n+        node = builder.extract_node(\n+            \"\"\"\n+        from collections import namedtuple\n+        Tuple = namedtuple(\"while\", \"abc\")\n+        Tuple #@\n+        \"\"\"\n+        )\n+        inferred = next(node.infer())\n+        self.assertIs(util.Uninferable, inferred)  # would raise ValueError\n+\n+    def test_typeerror_does_not_crash_inference(self):\n+        node = builder.extract_node(\n+            \"\"\"\n+        from collections import namedtuple\n+        Tuple = namedtuple(\"Tuple\", [123, 456])\n+        Tuple #@\n+        \"\"\"\n+        )\n+        inferred = next(node.infer())\n+        # namedtuple converts all arguments to strings so these should be too\n+        # and catch on the isidentifier() check\n+        self.assertIs(util.Uninferable, inferred)\n+\n+    def test_pathological_str_does_not_crash_inference(self):\n+        node = builder.extract_node(\n+            \"\"\"\n+        from collections import namedtuple\n+        class Invalid:\n+            def __str__(self):\n+                return 123  # will raise TypeError\n+        Tuple = namedtuple(\"Tuple\", [Invalid()])\n+        Tuple #@\n+        \"\"\"\n+        )\n+        inferred = next(node.infer())\n+        self.assertIs(util.Uninferable, inferred)\n+\n \n class DefaultDictTest(unittest.TestCase):\n     def test_1(self):\n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/efc5be48e8294cea6c5335a3ad0821fa920fd1e6"
}