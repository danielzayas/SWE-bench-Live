{
  "all_hints_text": "> It seems like our test suite doesn't clean up properly and is somewhat reliant on a global state.\r\n\r\nThat would be the astroid cache, I guess ? \ud83d\ude04 We can clean it up now but recently it was a mutable default value of a function. I don't think we added the cache clean function for each tests nor should we do it imo.\nI found the cause. #1460 introduced a global state that can be wrong if the cache is cleared (and the builtins module is rebuilt). I have a tiny diff to fix it.\n\n",
  "base_commit": "fb31eede489b45498e65b1921b537f7bd2dd8c9b",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/97f151ef7bc70b7d8d489ab7888cf4295c711232",
    "https://github.com/pylint-dev/astroid/commit/3b6e9a2a6ce24a4cdd532dc3f57dd89aee352b45",
    "https://github.com/pylint-dev/astroid/commit/23ba696434e0f28a9af833463f07bb39a4968b0e",
    "https://github.com/pylint-dev/astroid/commit/ebb578d9e14fcc0eccbf64c5f8414101eca3efe4"
  ],
  "created_at": "2022-05-14T14:40:54Z",
  "hints_text": "> It seems like our test suite doesn't clean up properly and is somewhat reliant on a global state.\r\n\r\nThat would be the astroid cache, I guess ? \ud83d\ude04 We can clean it up now but recently it was a mutable default value of a function. I don't think we added the cache clean function for each tests nor should we do it imo.\n\n",
  "instance_id": "pylint-dev__astroid-1563",
  "issue_numbers": [
    1559
  ],
  "language": "python",
  "patch": "diff --git a/ChangeLog b/ChangeLog\nindex bd6ed51cda..2ba8f6fdd7 100644\n--- a/ChangeLog\n+++ b/ChangeLog\n@@ -17,6 +17,11 @@ Release date: TBA\n \n * Allowed ``AstroidManager.clear_cache`` to reload necessary brain plugins.\n \n+* Fixed incorrect inferences after rebuilding the builtins module, e.g. by calling\n+  ``AstroidManager.clear_cache``.\n+\n+  Closes #1559\n+\n * Rename ``ModuleSpec`` -> ``module_type`` constructor parameter to match attribute\n   name and improve typing. Use ``type`` instead.\n \ndiff --git a/astroid/manager.py b/astroid/manager.py\nindex 23330d5b95..eb65944ca6 100644\n--- a/astroid/manager.py\n+++ b/astroid/manager.py\n@@ -9,6 +9,7 @@\n \n from __future__ import annotations\n \n+import collections\n import os\n import types\n import zipimport\n@@ -377,7 +378,8 @@ def clear_cache(self) -> None:\n         clear_inference_tip_cache()\n \n         self.astroid_cache.clear()\n-        AstroidManager.brain[\"_transform\"] = TransformVisitor()\n+        # NB: not a new TransformVisitor()\n+        AstroidManager.brain[\"_transform\"].transforms = collections.defaultdict(list)\n \n         for lru_cache in (\n             LookupMixIn.lookup,\ndiff --git a/astroid/nodes/scoped_nodes/utils.py b/astroid/nodes/scoped_nodes/utils.py\nindex 7217f081be..043cb01ca4 100644\n--- a/astroid/nodes/scoped_nodes/utils.py\n+++ b/astroid/nodes/scoped_nodes/utils.py\n@@ -8,7 +8,6 @@\n \n from __future__ import annotations\n \n-import builtins\n from collections.abc import Sequence\n from typing import TYPE_CHECKING\n \n@@ -18,18 +17,18 @@\n     from astroid import nodes\n \n \n-_builtin_astroid: nodes.Module | None = None\n-\n-\n def builtin_lookup(name: str) -> tuple[nodes.Module, Sequence[nodes.NodeNG]]:\n     \"\"\"Lookup a name in the builtin module.\n \n     Return the list of matching statements and the ast for the builtin module\n     \"\"\"\n-    # pylint: disable-next=global-statement\n-    global _builtin_astroid\n-    if _builtin_astroid is None:\n-        _builtin_astroid = AstroidManager().ast_from_module(builtins)\n+    manager = AstroidManager()\n+    try:\n+        _builtin_astroid = manager.builtins_module\n+    except KeyError:\n+        # User manipulated the astroid cache directly! Rebuild everything.\n+        manager.clear_cache()\n+        _builtin_astroid = manager.builtins_module\n     if name == \"__dict__\":\n         return _builtin_astroid, ()\n     try:\ndiff --git a/astroid/transforms.py b/astroid/transforms.py\nindex 8a9fb5dc64..3f36d75791 100644\n--- a/astroid/transforms.py\n+++ b/astroid/transforms.py\n@@ -20,6 +20,8 @@ class TransformVisitor:\n     :meth:`~visit` with an *astroid* module and the class\n     will take care of the rest, walking the tree and running the\n     transforms for each encountered node.\n+\n+    Based on its usage in AstroidManager.brain, it should not be reinstantiated.\n     \"\"\"\n \n     def __init__(self):\n",
  "problem_statement": "Pollution test cases\nWhile debugging #1551, I used [dectect-test-pollution](https://github.com/asottile/detect-test-pollution) to isolate the test case.\r\n\r\nThe tool does have a fuzzy mode which can find other pollution test cases. Unfortunately, it didn't even make it past round `1` \ud83d\ude15\r\nIt seems like our test suite doesn't clean up properly and is somewhat reliant on a global state. For now it's fine to continue as is though, at some point, these issues might come back to haunt us.\r\n\r\n**Install**\r\n```\r\npip install detect-test-pollution\r\n```\r\n\r\n**Run with** (Python 3.10)\r\n```\r\ndetect-test-pollution --tests tests/ --fuzz --runs 10\r\n```\r\n\r\nIf someone would like to take a look, that would be greatly appreciated \ud83d\ude4f\ud83c\udffb\r\n\r\n/CC: @jacobtylerwalls and @DanielNoord I saw you two worked on caching recently, maybe this is something you could take a look at?\r\n\r\n/CC: @Pierre-Sassoulas\r\n\r\n--\r\n#### The first case I saw\r\n\r\n**Failing test**: `tests/unittest_brain.py::TestIsinstanceInference::test_isinstance_int_true`\r\n**Pollution test**: `tests/unittest_manager.py::ClearCacheTest::test_brain_plugins_reloaded_after_clearing_cache`\r\n```\r\npytest \\\r\n    tests/unittest_manager.py::ClearCacheTest::test_brain_plugins_reloaded_after_clearing_cache \\\r\n    tests/unittest_brain.py::TestIsinstanceInference::test_isinstance_int_true \r\n```\n",
  "pull_number": 1563,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/unittest_manager.py b/tests/unittest_manager.py\nindex cd63950ea2..8c8dd4bf33 100644\n--- a/tests/unittest_manager.py\n+++ b/tests/unittest_manager.py\n@@ -318,7 +318,7 @@ def test_borg(self) -> None:\n         self.assertIs(built, second_built)\n \n \n-class ClearCacheTest(unittest.TestCase, resources.AstroidCacheSetupMixin):\n+class ClearCacheTest(unittest.TestCase):\n     def test_clear_cache_clears_other_lru_caches(self) -> None:\n         lrus = (\n             astroid.nodes.node_classes.LookupMixIn.lookup,\n@@ -362,6 +362,19 @@ def test_brain_plugins_reloaded_after_clearing_cache(self) -> None:\n         inferred = next(format_call.infer())\n         self.assertIsInstance(inferred, Const)\n \n+    def test_builtins_inference_after_clearing_cache(self) -> None:\n+        astroid.MANAGER.clear_cache()\n+        isinstance_call = astroid.extract_node(\"isinstance(1, int)\")\n+        inferred = next(isinstance_call.infer())\n+        self.assertIs(inferred.value, True)\n+\n+    def test_builtins_inference_after_clearing_cache_manually(self) -> None:\n+        # Not recommended to manipulate this, so we detect it and call clear_cache() instead\n+        astroid.MANAGER.brain[\"astroid_cache\"].clear()\n+        isinstance_call = astroid.extract_node(\"isinstance(1, int)\")\n+        inferred = next(isinstance_call.infer())\n+        self.assertIs(inferred.value, True)\n+\n \n if __name__ == \"__main__\":\n     unittest.main()\n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/fb31eede489b45498e65b1921b537f7bd2dd8c9b"
}