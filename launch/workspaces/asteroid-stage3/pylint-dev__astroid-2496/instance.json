{
  "all_hints_text": "@ericvergnaud would you be available to take a look at this?\n> @ericvergnaud would you be available to take a look at this?\r\n\r\nDone, see https://github.com/pylint-dev/astroid/pull/2496\n\n",
  "base_commit": "8d3cdbbe6685fd8cf211816bec56c90f38f1859e",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/c7bb7707a6d4f7e1fb8705e7a8e6052875cf1de9",
    "https://github.com/pylint-dev/astroid/commit/b4d3c8820541d58d69520d06dcfddba2647bf694",
    "https://github.com/pylint-dev/astroid/commit/e8357255cb3dd84f3b42cb962e4e51852fd5059c",
    "https://github.com/pylint-dev/astroid/commit/060a47897cfa540797b6d5911864bd687b2485b9",
    "https://github.com/pylint-dev/astroid/commit/13de091ee6f5e51117078865f55ff1362055864d",
    "https://github.com/pylint-dev/astroid/commit/4a40de4584e3ddfba4a65ece31a2e5cc12209172",
    "https://github.com/pylint-dev/astroid/commit/944edf986039e082fe8581e8d921ec7926ec423b",
    "https://github.com/pylint-dev/astroid/commit/4eed6b0b43a3a1dfea5670d2af6b89c147e2bbb8",
    "https://github.com/pylint-dev/astroid/commit/9ec6869311f6ef5ce938ab490f8ff1acb6b4521f",
    "https://github.com/pylint-dev/astroid/commit/31dcc981c76fd2317666d9f4bacb33f78a81e31c",
    "https://github.com/pylint-dev/astroid/commit/f02df6987b14a8329db3976839974fac76782cfa"
  ],
  "created_at": "2024-08-06T08:43:44Z",
  "hints_text": "@ericvergnaud would you be available to take a look at this?\n\n",
  "instance_id": "pylint-dev__astroid-2496",
  "issue_numbers": [
    2492
  ],
  "language": "python",
  "patch": "diff --git a/ChangeLog b/ChangeLog\nindex 4560e5d2b7..c08b1cbf2c 100644\n--- a/ChangeLog\n+++ b/ChangeLog\n@@ -13,6 +13,9 @@ What's New in astroid 3.3.1?\n ============================\n Release date: TBA\n \n+* Fix a crash introduced in 3.3.0 involving invalid format strings.\n+\n+  Closes #2492\n \n \n What's New in astroid 3.3.0?\ndiff --git a/astroid/nodes/node_classes.py b/astroid/nodes/node_classes.py\nindex c1c7af36da..1924c78eba 100644\n--- a/astroid/nodes/node_classes.py\n+++ b/astroid/nodes/node_classes.py\n@@ -4687,19 +4687,24 @@ def _infer(\n                     uninferable_already_generated = True\n                 continue\n             for value in self.value.infer(context, **kwargs):\n-                if not isinstance(value, Const):\n-                    if not uninferable_already_generated:\n-                        yield util.Uninferable\n-                        uninferable_already_generated = True\n-                    continue\n-                formatted = format(value.value, format_spec.value)\n-                yield Const(\n-                    formatted,\n-                    lineno=self.lineno,\n-                    col_offset=self.col_offset,\n-                    end_lineno=self.end_lineno,\n-                    end_col_offset=self.end_col_offset,\n-                )\n+                if isinstance(value, Const):\n+                    try:\n+                        formatted = format(value.value, format_spec.value)\n+                        yield Const(\n+                            formatted,\n+                            lineno=self.lineno,\n+                            col_offset=self.col_offset,\n+                            end_lineno=self.end_lineno,\n+                            end_col_offset=self.end_col_offset,\n+                        )\n+                        continue\n+                    except (ValueError, TypeError):\n+                        # happens when format_spec.value is invalid\n+                        pass  # fall through\n+                if not uninferable_already_generated:\n+                    yield util.Uninferable\n+                    uninferable_already_generated = True\n+                continue\n \n \n MISSING_VALUE = \"{MISSING_VALUE}\"\n",
  "problem_statement": "TypeError: unsupported format string passed to NoneType.__format__\nRegression in #2459\r\n\r\n### Steps to reproduce\r\na.py:\r\n```py\r\nclass A:\r\n    def __init__(self):\r\n        self._magnitude = None\r\n\r\n    def name(self) -> str | None:\r\n        if self._magnitude:\r\n            return f\"M {self._magnitude:.1f}\"\r\n```\r\n```\r\npylint a.py\r\n```\r\n### Current behavior\r\n```\r\n  File \"/Users/jwalls/release/lib/python3.12/site-packages/astroid/nodes/node_classes.py\", line 4778, in _infer_from_values\r\n    yield from nodes[0]._infer(context, **kwargs)\r\n  File \"/Users/jwalls/release/lib/python3.12/site-packages/astroid/nodes/node_classes.py\", line 4695, in _infer\r\n    formatted = format(value.value, format_spec.value)\r\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nTypeError: unsupported format string passed to NoneType.__format__\r\n```\n",
  "pull_number": 2496,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/test_inference.py b/tests/test_inference.py\nindex 61378043c3..a8b11b1614 100644\n--- a/tests/test_inference.py\n+++ b/tests/test_inference.py\n@@ -666,21 +666,6 @@ def test_fstring_inference(self) -> None:\n         self.assertIsInstance(value_node, Const)\n         self.assertEqual(value_node.value, \"Hello John!\")\n \n-    def test_formatted_fstring_inference(self) -> None:\n-        code = \"\"\"\n-            width = 10\n-            precision = 4\n-            value = 12.34567\n-            result = f\"result: {value:{width}.{precision}}!\"\n-            \"\"\"\n-        ast = parse(code, __name__)\n-        node = ast[\"result\"]\n-        inferred = node.inferred()\n-        self.assertEqual(len(inferred), 1)\n-        value_node = inferred[0]\n-        self.assertIsInstance(value_node, Const)\n-        self.assertEqual(value_node.value, \"result:      12.35!\")\n-\n     def test_float_complex_ambiguity(self) -> None:\n         code = '''\n             def no_conjugate_member(magic_flag):  #@\n@@ -5517,6 +5502,51 @@ class instance(object):\n         self.assertIsInstance(inferred, Instance)\n \n \n+@pytest.mark.parametrize(\n+    \"code, result\",\n+    [\n+        # regular f-string\n+        (\n+            \"\"\"width = 10\n+precision = 4\n+value = 12.34567\n+result = f\"result: {value:{width}.{precision}}!\"\n+\"\"\",\n+            \"result:      12.35!\",\n+        ),\n+        # unsupported format\n+        (\n+            \"\"\"width = None\n+precision = 4\n+value = 12.34567\n+result = f\"result: {value:{width}.{precision}}!\"\n+\"\"\",\n+            None,\n+        ),\n+        # unsupported value\n+        (\n+            \"\"\"width = 10\n+precision = 4\n+value = None\n+result = f\"result: {value:{width}.{precision}}!\"\n+\"\"\",\n+            None,\n+        ),\n+    ],\n+)\n+def test_formatted_fstring_inference(code, result) -> None:\n+    ast = parse(code, __name__)\n+    node = ast[\"result\"]\n+    inferred = node.inferred()\n+    assert len(inferred) == 1\n+    value_node = inferred[0]\n+    if result is None:\n+        assert value_node is util.Uninferable\n+    else:\n+        assert isinstance(value_node, Const)\n+        assert value_node.value == result\n+\n+\n def test_augassign_recursion() -> None:\n     \"\"\"Make sure inference doesn't throw a RecursionError.\n \n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/8d3cdbbe6685fd8cf211816bec56c90f38f1859e"
}