{
  "all_hints_text": "It appears that this is caused by `InferenceContext` maintaining a strong reference to the mutable set that is shared between clones, see this simplified example:\r\n\r\n```python\r\nclass Context:\r\n    def __init__(self, path=None):\r\n        self.path = path or set()\r\n    def clone(self):\r\n        return Context(path=self.path)\r\n\r\na = Context()\r\na.path.add('hello')\r\nb = a.clone()\r\nb.path.add('world')\r\nprint(a.path, b.path)\r\n# (set(['world', 'hello']), set(['world', 'hello']))\r\nprint(a.path is b.path)\r\n# True\r\n```\n\n",
  "base_commit": "cd8b6a43192724128af68605ef22aabf3254f495",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/ed77a1ba3d762497005f2c5f3d6a4839135ce341",
    "https://github.com/pylint-dev/astroid/commit/c4bf1579a4bcd97dd03c52093462b6b657515b3c",
    "https://github.com/pylint-dev/astroid/commit/f581d935509be60f1b4ef3c3b3dcbfa60c2946e9",
    "https://github.com/pylint-dev/astroid/commit/2bc5fcf2d3723e515498f81ec73da04fb1e8eb23",
    "https://github.com/pylint-dev/astroid/commit/0e5cd49838b893c74105d0853e5019db8ec3340e",
    "https://github.com/pylint-dev/astroid/commit/165e8d97fd2ba12271d3254848f8a928d980e7af"
  ],
  "created_at": "2021-03-29T12:55:48Z",
  "hints_text": "\n\n",
  "instance_id": "pylint-dev__astroid-927",
  "issue_numbers": [
    926
  ],
  "language": "python",
  "patch": "diff --git a/ChangeLog b/ChangeLog\nindex 12fae5ceab..05d9256b7e 100644\n--- a/ChangeLog\n+++ b/ChangeLog\n@@ -14,6 +14,11 @@ Release Date: TBA\n  Closes PyCQA/pylint#3970\n  Closes PyCQA/pylint#3595\n \n+* Fix some spurious cycles detected in ``context.path`` leading to more cases\n+  that can now be inferred\n+\n+  Closes #926\n+\n \n What's New in astroid 2.5.6?\n ============================\ndiff --git a/astroid/context.py b/astroid/context.py\nindex 18220ec228..d7bf81bf17 100644\n--- a/astroid/context.py\n+++ b/astroid/context.py\n@@ -102,7 +102,7 @@ def clone(self):\n         starts with the same context but diverge as each side is inferred\n         so the InferenceContext will need be cloned\"\"\"\n         # XXX copy lookupname/callcontext ?\n-        clone = InferenceContext(self.path, inferred=self.inferred)\n+        clone = InferenceContext(self.path.copy(), inferred=self.inferred.copy())\n         clone.callcontext = self.callcontext\n         clone.boundnode = self.boundnode\n         clone.extra_context = self.extra_context\n",
  "problem_statement": "infer_stmts cannot infer multiple uses of the same AssignName\nGiven multiple assignments to the same target which both reference the same AssignName, infer_stmts fails for subsequent attempts after the first.\r\n\r\n### Steps to reproduce\r\n\r\nThis appears to be a minimum working example, removing any part removes the effect:\r\n\r\n```python\r\nfails = astroid.extract_node(\"\"\"\r\n    pair = [1, 2]\r\n    ex = pair[0]\r\n    if 1 + 1 == 2:\r\n        ex = pair[1]\r\n    ex\r\n\"\"\")\r\nprint(list(fails.infer()))\r\n# [<Const.int l.2 at 0x...>, Uninferable]\r\n```\r\n\r\nFor some context, I originally saw this with attributes on an imported module, i.e.\r\n\r\n```python\r\nimport mod\r\nex = mod.One()\r\n# later ... or in some branch\r\nex = mod.Two()\r\n```\r\n\r\n### Current behavior\r\n\r\nSee above.\r\n\r\n### Expected behavior\r\n\r\nInlining the variable or switching to a different name works fine:\r\n\r\n```python\r\nworks = astroid.extract_node(\"\"\"\r\n    # pair = [1, 2]\r\n    ex = [1, 2][0]\r\n    if 1 + 1 == 2:\r\n        ex = [1, 2][1]\r\n    ex\r\n\"\"\")\r\nprint(list(works.infer()))\r\n# [<Const.int l.3 at 0x...>, <Const.int l.5 at 0x...>]\r\n\r\nworks = astroid.extract_node(\"\"\"\r\n    first = [1, 2]\r\n    second = [1, 2]\r\n    ex = first[0]\r\n    if 1 + 1 == 2:\r\n        ex = second[1]\r\n    ex\r\n\"\"\")\r\nprint(list(works.infer()))\r\n# [<Const.int l.2 at 0x...>, <Const.int l.3 at 0x...>]\r\n```\r\n\r\nI would expect that the first failing example would work similarly. This (only) worked\r\nin astroid 2.5 and appears to have been \"broken\" by the revert of cc3bfc5 in 03d15b0 (astroid 2.5.1 and above).\r\n\r\n### ``python -c \"from astroid import __pkginfo__; print(__pkginfo__.version)\"`` output\r\n\r\n```\r\n$ python -c \"from astroid import __pkginfo__; print(__pkginfo__.version)\"\r\n2.5-dev\r\n$ git rev-parse HEAD\r\n03d15b0f32f7d7c9b2cb062b9321e531bd954344\r\n```\r\n\n",
  "pull_number": 927,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/unittest_brain_numpy_core_umath.py b/tests/unittest_brain_numpy_core_umath.py\nindex 12c1e3bbbc..5559bdd581 100644\n--- a/tests/unittest_brain_numpy_core_umath.py\n+++ b/tests/unittest_brain_numpy_core_umath.py\n@@ -14,7 +14,7 @@\n except ImportError:\n     HAS_NUMPY = False\n \n-from astroid import bases, builder, nodes, util\n+from astroid import bases, builder, nodes\n \n \n @unittest.skipUnless(HAS_NUMPY, \"This test requires the numpy library.\")\n@@ -220,9 +220,7 @@ def test_numpy_core_umath_functions_return_type(self):\n             with self.subTest(typ=func_):\n                 inferred_values = list(self._inferred_numpy_func_call(func_))\n                 self.assertTrue(\n-                    len(inferred_values) == 1\n-                    or len(inferred_values) == 2\n-                    and inferred_values[-1].pytype() is util.Uninferable,\n+                    len(inferred_values) == 1,\n                     msg=\"Too much inferred values ({}) for {:s}\".format(\n                         inferred_values[-1].pytype(), func_\n                     ),\ndiff --git a/tests/unittest_inference.py b/tests/unittest_inference.py\nindex ce15e1efd1..ba1637ceb3 100644\n--- a/tests/unittest_inference.py\n+++ b/tests/unittest_inference.py\n@@ -1704,7 +1704,8 @@ def __init__(self):\n         \"\"\"\n         ast = extract_node(code, __name__)\n         expr = ast.func.expr\n-        self.assertIs(next(expr.infer()), util.Uninferable)\n+        with pytest.raises(exceptions.InferenceError):\n+            next(expr.infer())\n \n     def test_tuple_builtin_inference(self):\n         code = \"\"\"\n@@ -6032,5 +6033,37 @@ def test_infer_list_of_uninferables_does_not_crash():\n     assert not inferred.elts\n \n \n+# https://github.com/PyCQA/astroid/issues/926\n+def test_issue926_infer_stmts_referencing_same_name_is_not_uninferable():\n+    code = \"\"\"\n+    pair = [1, 2]\n+    ex = pair[0]\n+    if 1 + 1 == 2:\n+        ex = pair[1]\n+    ex\n+    \"\"\"\n+    node = extract_node(code)\n+    inferred = list(node.infer())\n+    assert len(inferred) == 2\n+    assert isinstance(inferred[0], nodes.Const)\n+    assert inferred[0].value == 1\n+    assert isinstance(inferred[1], nodes.Const)\n+    assert inferred[1].value == 2\n+\n+\n+# https://github.com/PyCQA/astroid/issues/926\n+def test_issue926_binop_referencing_same_name_is_not_uninferable():\n+    code = \"\"\"\n+    pair = [1, 2]\n+    ex = pair[0] + pair[1]\n+    ex\n+    \"\"\"\n+    node = extract_node(code)\n+    inferred = list(node.infer())\n+    assert len(inferred) == 1\n+    assert isinstance(inferred[0], nodes.Const)\n+    assert inferred[0].value == 3\n+\n+\n if __name__ == \"__main__\":\n     unittest.main()\ndiff --git a/tests/unittest_regrtest.py b/tests/unittest_regrtest.py\nindex 29febfb8f6..acabde135e 100644\n--- a/tests/unittest_regrtest.py\n+++ b/tests/unittest_regrtest.py\n@@ -99,7 +99,7 @@ def test_numpy_crash(self):\n         astroid = builder.string_build(data, __name__, __file__)\n         callfunc = astroid.body[1].value.func\n         inferred = callfunc.inferred()\n-        self.assertEqual(len(inferred), 2)\n+        self.assertEqual(len(inferred), 1)\n \n     def test_nameconstant(self):\n         # used to fail for Python 3.4\n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/cd8b6a43192724128af68605ef22aabf3254f495"
}