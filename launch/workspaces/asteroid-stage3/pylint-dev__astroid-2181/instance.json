{
  "all_hints_text": "\n\n",
  "base_commit": "835de848ac7cf51525d714f2f6ed07d789e09c54",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/6bdd92d1006ae73bd5747d7c3714e10de81f1818",
    "https://github.com/pylint-dev/astroid/commit/c807c03c48aea8e458a7db3df7f7b35e1cdffc6b",
    "https://github.com/pylint-dev/astroid/commit/4757af207d96fa5ee50a453d452e35af083d49a4",
    "https://github.com/pylint-dev/astroid/commit/59221837058252bad1344186040a1e475f045c4a",
    "https://github.com/pylint-dev/astroid/commit/5a33300db2c4927d5397d41b8e6f78348c6b9316"
  ],
  "created_at": "2023-05-15T01:44:33Z",
  "hints_text": "\n\n",
  "instance_id": "pylint-dev__astroid-2181",
  "issue_numbers": [
    2180
  ],
  "language": "python",
  "patch": "diff --git a/astroid/context.py b/astroid/context.py\nindex a151ca6260..cccc81c077 100644\n--- a/astroid/context.py\n+++ b/astroid/context.py\n@@ -140,6 +140,18 @@ def restore_path(self) -> Iterator[None]:\n         yield\n         self.path = path\n \n+    def is_empty(self) -> bool:\n+        return (\n+            not self.path\n+            and not self.nodes_inferred\n+            and not self.callcontext\n+            and not self.boundnode\n+            and not self.lookupname\n+            and not self.callcontext\n+            and not self.extra_context\n+            and not self.constraints\n+        )\n+\n     def __str__(self) -> str:\n         state = (\n             f\"{field}={pprint.pformat(getattr(self, field), width=80 - len(field))}\"\ndiff --git a/astroid/inference_tip.py b/astroid/inference_tip.py\nindex 44a7fcf15a..9eda5b4fc7 100644\n--- a/astroid/inference_tip.py\n+++ b/astroid/inference_tip.py\n@@ -6,6 +6,7 @@\n \n from __future__ import annotations\n \n+from collections import OrderedDict\n from collections.abc import Generator\n from typing import Any, TypeVar\n \n@@ -18,9 +19,9 @@\n     TransformFn,\n )\n \n-_cache: dict[\n+_cache: OrderedDict[\n     tuple[InferFn[Any], NodeNG, InferenceContext | None], list[InferenceResult]\n-] = {}\n+] = OrderedDict()\n \n _CURRENTLY_INFERRING: set[tuple[InferFn[Any], NodeNG]] = set()\n \n@@ -44,7 +45,11 @@ def inner(\n         if partial_cache_key in _CURRENTLY_INFERRING:\n             # If through recursion we end up trying to infer the same\n             # func + node we raise here.\n+            _CURRENTLY_INFERRING.remove(partial_cache_key)\n             raise UseInferenceDefault\n+        if context is not None and context.is_empty():\n+            # Fresh, empty contexts will defeat the cache.\n+            context = None\n         try:\n             yield from _cache[func, node, context]\n             return\n@@ -55,11 +60,23 @@ def inner(\n             # with slightly different contexts while still passing the simple\n             # test cases included with this commit.\n             _CURRENTLY_INFERRING.add(partial_cache_key)\n-            result = _cache[func, node, context] = list(func(node, context, **kwargs))\n-            # Remove recursion guard.\n-            _CURRENTLY_INFERRING.remove(partial_cache_key)\n-\n-        yield from result\n+            try:\n+                # May raise UseInferenceDefault\n+                result = _cache[func, node, context] = list(\n+                    func(node, context, **kwargs)\n+                )\n+            finally:\n+                # Remove recursion guard.\n+                try:\n+                    _CURRENTLY_INFERRING.remove(partial_cache_key)\n+                except KeyError:\n+                    pass  # Recursion may beat us to the punch.\n+\n+                if len(_cache) > 64:\n+                    _cache.popitem(last=False)\n+\n+        # https://github.com/pylint-dev/pylint/issues/8686\n+        yield from result  # pylint: disable=used-before-assignment\n \n     return inner\n \n",
  "problem_statement": "Inference tip cache is unbounded\nSee [failing pylint primer runs](https://github.com/pylint-dev/pylint/actions/runs/4973881710).\r\n\r\nMy mac shows 20% performance regression running `time pylint music21`.\r\n\r\nbisected to #2158\r\n\r\n#### initial ideas:\r\n- the inference tip cache probably needs to be rewritten as an LRU cache.\r\n- or, we need to hash equivalent InferenceContexts somehow (I [started to explore this](https://github.com/pylint-dev/astroid/pull/2158/commits/38955bf992cd0dda6b95b8d48f282a3f0b4a42bb) in #2158 but didn't ultimately pursue it)\n",
  "pull_number": 2181,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/test_inference.py b/tests/test_inference.py\nindex 3de2c17b00..29bf56ac2c 100644\n--- a/tests/test_inference.py\n+++ b/tests/test_inference.py\n@@ -31,7 +31,7 @@\n from astroid.arguments import CallSite\n from astroid.bases import BoundMethod, Instance, UnboundMethod, UnionType\n from astroid.builder import AstroidBuilder, _extract_single_node, extract_node, parse\n-from astroid.const import PY39_PLUS, PY310_PLUS\n+from astroid.const import IS_PYPY, PY39_PLUS, PY310_PLUS\n from astroid.context import CallContext, InferenceContext\n from astroid.exceptions import (\n     AstroidTypeError,\n@@ -6976,6 +6976,9 @@ def test_imported_module_var_inferable3() -> None:\n     assert i_w_val.as_string() == \"['w', 'v']\"\n \n \n+@pytest.mark.skipif(\n+    IS_PYPY, reason=\"Test run with coverage on PyPy sometimes raises a RecursionError\"\n+)\n def test_recursion_on_inference_tip() -> None:\n     \"\"\"Regression test for recursion in inference tip.\n \n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/835de848ac7cf51525d714f2f6ed07d789e09c54"
}