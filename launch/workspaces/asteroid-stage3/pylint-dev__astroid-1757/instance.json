{
  "all_hints_text": "The PR you are referring to can't really be the issue here: it's not included in `2.12.4` as it is targeted for `2.13.0`. This sound like another `is_namespace` issue where we assume that a namespace package has a `__path__` attribute but our recognition of namespaces packages isn't perfect.\r\n\r\nI'll likely have some time to investigate this next week if nobody gets to it before that.\nYes, you are correct, @DanielNoord - sorry about that. I saw your commit sandwiched between the version bumps in Astroid and made a bad assumption. I can see now that your change was not in 2.12.4 and, indeed, no relevant commit is in that release or the previous one. Looks like the recent Pylint release bumped the Astroid requirement from 2.11 to 2.12 and so the offender is in a wider range of commits going further back in time. (Will correct the description for this bug report.) The last version of Astroid known to work for me is 2.11.7, which Pylint 2.14.5 was using.\nThanks for the report @emcd. I don't have PyPy spun up locally. Could you provide me the output of the following?\r\n\r\n```python\r\n>>> import importlib\r\n>>> importlib._bootstrap.__spec__.origin\r\n'frozen'\r\n```\n@jacobtylerwalls : Sure. Looks like that subattribute doesn't exist in PyPy 3.8 because the `__spec__` attribute is `None`:\r\n```\r\n$ python -c 'import sys, importlib; print( sys.version_info ); print( sys.pypy_version_info ); print( importlib._bootstrap.__spec__.origin )'\r\nsys.version_info(major=3, minor=8, micro=13, releaselevel='final', serial=0)\r\nsys.pypy_version_info(major=7, minor=3, micro=9, releaselevel='final', serial=0)\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 1, in <module>\r\nAttributeError: 'NoneType' object has no attribute 'origin'\r\n$ python -c 'import importlib; print( type( importlib._bootstrap.__spec__ ) )'\r\n<class 'NoneType'>\r\n```\nVery helpful, @emcd! Would you be able to try out #1757 and let us know if it resolves your issue?\nWow - that was a quick fix!\r\nYes, it seems to work:\r\n```\r\n(pypy-3.8-7.3--linux--glibc-2.31--x86_64) ~/src/THIRD_PARTY/astroid$ git remote -v\r\norigin  https://github.com/jacobtylerwalls/astroid.git (fetch)\r\norigin  https://github.com/jacobtylerwalls/astroid.git (push)\r\n(pypy-3.8-7.3--linux--glibc-2.31--x86_64) ~/src/THIRD_PARTY/astroid$ git branch\r\n  main\r\n* pypy-importlib\r\n(pypy-3.8-7.3--linux--glibc-2.31--x86_64) ~/src/THIRD_PARTY/astroid$ pip install . pylint==2.15.0\r\nProcessing /home/me/src/THIRD_PARTY/astroid\r\n  Installing build dependencies ... done\r\n  Getting requirements to build wheel ... done\r\n  Preparing metadata (pyproject.toml) ... done\r\nCollecting pylint==2.15.0\r\n  Using cached pylint-2.15.0-py3-none-any.whl (505 kB)\r\nRequirement already satisfied: dill>=0.2 in /home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages (from pylint==2.15.0) (0.3.5.1)\r\nRequirement already satisfied: platformdirs>=2.2.0 in /home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages (from pylint==2.15.0) (2.5.2)\r\nRequirement already satisfied: isort<6,>=4.2.5 in /home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages (from pylint==2.15.0) (5.10.1)\r\nRequirement already satisfied: mccabe<0.8,>=0.6 in /home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages (from pylint==2.15.0) (0.7.0)\r\nRequirement already satisfied: tomlkit>=0.10.1 in /home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages (from pylint==2.15.0) (0.11.4)\r\nRequirement already satisfied: typing-extensions>=3.10.0 in /home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages (from pylint==2.15.0) (4.3.0)\r\nRequirement already satisfied: tomli>=1.1.0 in /home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages (from pylint==2.15.0) (2.0.1)\r\nRequirement already satisfied: lazy-object-proxy>=1.4.0 in /home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages (from astroid==2.13.0.dev0) (1.7.1)\r\nRequirement already satisfied: wrapt<2,>=1.11 in /home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages (from astroid==2.13.0.dev0) (1.14.1)\r\nBuilding wheels for collected packages: astroid\r\n  Building wheel for astroid (pyproject.toml) ... done\r\n  Created wheel for astroid: filename=astroid-2.13.0.dev0-py3-none-any.whl size=262428 sha256=43e1ac2b6917aadd158af5953d9f828901aa72dfaab819c0805fb0299eef1083\r\n  Stored in directory: /tmp/pip-ephem-wheel-cache-pew8kghc/wheels/74/ef/57/67019fcf38c5abad1df8a9c4b4e7224bd2721b0744f45a56b0\r\nSuccessfully built astroid\r\nInstalling collected packages: astroid, pylint\r\n  Attempting uninstall: astroid\r\n    Found existing installation: astroid 2.13.0.dev0\r\n    Uninstalling astroid-2.13.0.dev0:\r\n      Successfully uninstalled astroid-2.13.0.dev0\r\n  Attempting uninstall: pylint\r\n    Found existing installation: pylint 2.14.5\r\n    Uninstalling pylint-2.14.5:\r\n      Successfully uninstalled pylint-2.14.5\r\nSuccessfully installed astroid-2.13.0.dev0 pylint-2.15.0\r\n```\r\n```\r\n(pypy-3.8-7.3--linux--glibc-2.31--x86_64) ~/src/python-lockup$ pylint --version\r\npylint 2.15.0\r\nastroid 2.13.0-dev0\r\nPython 3.8.13 (4b1398fe9d76ad762155d03684c2a153d230b2ef, Mar 29 2022, 07:08:24)\r\n[PyPy 7.3.9 with GCC 10.2.1 20210130 (Red Hat 10.2.1-11)]\r\n(pypy-3.8-7.3--linux--glibc-2.31--x86_64) ~/src/python-lockup$ cat astroid_bug.py\r\n''' Docstring of Pylint appeasement. '''\r\nfrom importlib import import_module\r\npackage = import_module( 'os' )\r\n(pypy-3.8-7.3--linux--glibc-2.31--x86_64) ~/src/python-lockup$ pylint astroid_bug.py\r\n\r\n\r\nReport\r\n======\r\n2 statements analysed.\r\n\r\n...\r\n\r\nMessages\r\n--------\r\n\r\n+-----------+------------+\r\n|message id |occurrences |\r\n+===========+============+\r\n\r\n\r\n\r\n\r\n--------------------------------------------------------------------\r\nYour code has been rated at 10.00/10 (previous run: 10.00/10, +0.00)\r\n```\r\n\r\nThank you.\n\n",
  "base_commit": "13b1c7fa08d5a238b3995b17de551abd5d31993e",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/e51294111449bb17ac1dba96d71b6fd6ced3388d",
    "https://github.com/pylint-dev/astroid/commit/380659b96d85c696de865a31506aafcfcef7d908",
    "https://github.com/pylint-dev/astroid/commit/521bbc0f32f38d673c3d924060076f0ea7160d9b"
  ],
  "created_at": "2022-08-27T19:18:47Z",
  "hints_text": "\n\n",
  "instance_id": "pylint-dev__astroid-1757",
  "issue_numbers": [
    1755
  ],
  "language": "python",
  "patch": "diff --git a/ChangeLog b/ChangeLog\nindex 3a7721f2b0..ff7540f018 100644\n--- a/ChangeLog\n+++ b/ChangeLog\n@@ -17,6 +17,10 @@ What's New in astroid 2.12.5?\n =============================\n Release date: TBA\n \n+* Fix ``astroid.interpreter._import.util.is_namespace()`` incorrectly\n+  returning ``True`` for frozen stdlib modules on PyPy.\n+\n+  Closes #1755\n \n \n What's New in astroid 2.12.4?\ndiff --git a/astroid/interpreter/_import/util.py b/astroid/interpreter/_import/util.py\nindex f082e9c4a7..3bdf0470f3 100644\n--- a/astroid/interpreter/_import/util.py\n+++ b/astroid/interpreter/_import/util.py\n@@ -10,6 +10,8 @@\n from importlib._bootstrap_external import _NamespacePath\n from importlib.util import _find_spec_from_path  # type: ignore[attr-defined]\n \n+from astroid.const import IS_PYPY\n+\n \n @lru_cache(maxsize=4096)\n def is_namespace(modname: str) -> bool:\n@@ -38,7 +40,7 @@ def is_namespace(modname: str) -> bool:\n                 return False\n             try:\n                 # .pth files will be on sys.modules\n-                return sys.modules[modname].__spec__ is None\n+                return sys.modules[modname].__spec__ is None and not IS_PYPY\n             except KeyError:\n                 return False\n             except AttributeError:\n",
  "problem_statement": "Astroid 2.12.4 broken on PyPy 3.8 when `importlib.import_module` is used.\nEDIT: ~[Commit ddfba9c583287436f1c3498cb9f5fd919fb33ed0](https://github.com/PyCQA/astroid/commit/ddfba9c583287436f1c3498cb9f5fd919fb33ed0) is suspect.~ The actual suspect is further back in time.\r\n\r\n### Steps to reproduce\r\n\r\n1. Prepare an environment based on PyPy 7.3.9 (Python 3.8).\r\n2. Install latest Pylint and Astroid in this environment.\r\n3. Run Pylint against a Python source file, such as the following reproducer:\r\n    ``` python\r\n   from importlib import import_module\r\n   package = import_module( 'os' )\r\n    ```\r\n4. Observe an error along the lines of what is described in the `Current Behavior` section below.\r\n\r\n### Current behavior\r\n\r\n```\r\nException on node <ImportFrom l.1 at 0x7f57db63c448> in file '/home/me/src/python-lockup/astroid-bug.py'\r\nTraceback (most recent call last):\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/manager.py\", line 249, in file_from_module_name\r\n    value = self._mod_file_cache[(modname, contextfile)]\r\nKeyError: ('_frozen_importlib', None)\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/pylint/checkers/imports.py\", line 798, in _get_imported_module\r\n    return importnode.do_import_module(modname)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/nodes/_base_nodes.py\", line 149, in do_import_module\r\n    modname, level=level, relative_only=level and level >= 1\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/nodes/scoped_nodes/scoped_nodes.py\", line 521, in import_module\r\n    return AstroidManager().ast_from_module_name(absmodname)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/manager.py\", line 208, in ast_from_module_name\r\n    return self.ast_from_file(found_spec.location, modname, fallback=False)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/manager.py\", line 117, in ast_from_file\r\n    return AstroidBuilder(self).file_build(filepath, modname)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/builder.py\", line 135, in file_build\r\n    return self._post_build(module, builder, encoding)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/builder.py\", line 157, in _post_build\r\n    self.delayed_assattr(delayed)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/builder.py\", line 227, in delayed_assattr\r\n    for inferred in node.expr.infer():\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/nodes/node_ng.py\", line 169, in infer\r\n    yield from self._infer(context=context, **kwargs)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/decorators.py\", line 139, in raise_if_nothing_inferred\r\n    yield next(generator)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/decorators.py\", line 108, in wrapped\r\n    for res in _func(node, context, **kwargs):\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/bases.py\", line 165, in _infer_stmts\r\n    for inf in stmt.infer(context=context):  # type: ignore[union-attr]\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/nodes/node_ng.py\", line 182, in infer\r\n    for i, result in enumerate(self._infer(context=context, **kwargs)):\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/decorators.py\", line 139, in raise_if_nothing_inferred\r\n    yield next(generator)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/decorators.py\", line 108, in wrapped\r\n    for res in _func(node, context, **kwargs):\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/inference.py\", line 289, in infer_import\r\n    yield self.do_import_module(self.real_name(name))\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/nodes/_base_nodes.py\", line 149, in do_import_module\r\n    modname, level=level, relative_only=level and level >= 1\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/nodes/scoped_nodes/scoped_nodes.py\", line 521, in import_module\r\n    return AstroidManager().ast_from_module_name(absmodname)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/manager.py\", line 160, in ast_from_module_name\r\n    found_spec = self.file_from_module_name(modname, context_file)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/manager.py\", line 253, in file_from_module_name\r\n    modname.split(\".\"), context_file=contextfile\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/modutils.py\", line 384, in file_info_from_modpath\r\n    return _spec_from_modpath(modpath, path, context)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/modutils.py\", line 596, in _spec_from_modpath\r\n    found_spec = spec.find_spec(modpath, path)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/interpreter/_import/spec.py\", line 393, in find_spec\r\n    _path, modname, module_parts, processed, submodule_path or path\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/interpreter/_import/spec.py\", line 355, in _find_spec_with_path\r\n    modname, module_parts, processed, submodule_path\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/astroid/interpreter/_import/spec.py\", line 204, in find_module\r\n    submodule_path = sys.modules[modname].__path__\r\nAttributeError: module 'importlib._bootstrap' has no attribute '__path__'\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/pylint/utils/ast_walker.py\", line 90, in walk\r\n    callback(astroid)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/pylint/checkers/imports.py\", line 502, in visit_importfrom\r\n    imported_module = self._get_imported_module(node, basename)\r\n  File \"/home/me/src/python-lockup/.local/environments/pypy-3.8-7.3--linux--glibc-2.31--x86_64/lib/pypy3.8/site-packages/pylint/checkers/imports.py\", line 823, in _get_imported_module\r\n    raise astroid.AstroidError from e\r\nastroid.exceptions.AstroidError\r\nastroid-bug.py   1, 0 [astroid-error] astroid-bug.py: Fatal error while checking 'astroid-bug.py'. Please open an issue in our bug tracker so we address this. There is a pre-filled template that you can use in '/home/me/.cache/pylint/pylint-crash-2022-08-27-06-21-55.txt'.\r\n```\r\n\r\n### Expected behavior\r\n\r\nNo traceback. Exact same lint runs fine on all supported versions of CPython using same version of Pylint and Astroid.\r\nReference: https://github.com/emcd/python-lockup/runs/8047293310?check_suite_focus=true\r\n(Problem caught on a Github Action but also reproduced locally.)\r\n\r\nEDIT: ~Astroid 2.12.3 ran fine on PyPy 3.8.~ Was previously using Pylint 2.14.5 which used Astroid 2.11.7, which worked on all platforms that I test.\r\n\r\n### `python -c \"from astroid import __pkginfo__; print(__pkginfo__.version)\"` output\r\n2.12.4\n",
  "pull_number": 1757,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/unittest_manager.py b/tests/unittest_manager.py\nindex 5bce29041e..fd5787d442 100644\n--- a/tests/unittest_manager.py\n+++ b/tests/unittest_manager.py\n@@ -10,9 +10,11 @@\n from collections.abc import Iterator\n from contextlib import contextmanager\n \n+import pytest\n+\n import astroid\n from astroid import manager, test_utils\n-from astroid.const import IS_JYTHON\n+from astroid.const import IS_JYTHON, IS_PYPY\n from astroid.exceptions import AstroidBuildingError, AstroidImportError\n from astroid.interpreter._import import util\n from astroid.modutils import is_standard_module\n@@ -128,6 +130,7 @@ def test_submodule_homonym_with_non_module(self) -> None:\n     def test_module_is_not_namespace(self) -> None:\n         self.assertFalse(util.is_namespace(\"tests.testdata.python3.data.all\"))\n         self.assertFalse(util.is_namespace(\"__main__\"))\n+        self.assertFalse(util.is_namespace(\"importlib._bootstrap\"))\n \n     def test_module_unexpectedly_missing_spec(self) -> None:\n         astroid_module = sys.modules[\"astroid\"]\n@@ -155,6 +158,10 @@ def test_implicit_namespace_package(self) -> None:\n             for _ in range(2):\n                 sys.path.pop(0)\n \n+    @pytest.mark.skipif(\n+        IS_PYPY,\n+        reason=\"PyPy provides no way to tell apart frozen stdlib from old-style namespace packages\",\n+    )\n     def test_namespace_package_pth_support(self) -> None:\n         pth = \"foogle_fax-0.12.5-py2.7-nspkg.pth\"\n         site.addpackage(resources.RESOURCE_PATH, pth, [])\n@@ -169,6 +176,10 @@ def test_namespace_package_pth_support(self) -> None:\n         finally:\n             sys.modules.pop(\"foogle\")\n \n+    @pytest.mark.skipif(\n+        IS_PYPY,\n+        reason=\"PyPy provides no way to tell apart frozen stdlib from old-style namespace packages\",\n+    )\n     def test_nested_namespace_import(self) -> None:\n         pth = \"foogle_fax-0.12.5-py2.7-nspkg.pth\"\n         site.addpackage(resources.RESOURCE_PATH, pth, [])\n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/13b1c7fa08d5a238b3995b17de551abd5d31993e"
}