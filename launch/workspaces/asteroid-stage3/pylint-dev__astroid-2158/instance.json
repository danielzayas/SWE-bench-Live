{
  "all_hints_text": "Timing the pylint evaluation of checkers/ folder from pylint repo, I don't see a big difference with and without (explicit raise KeyError inserted) the cache:\r\nwith:\r\n```\r\nreal    0m57.994s\r\nreal    0m58.089s\r\nreal    0m57.446s\r\nreal    0m57.366s\r\n```\r\nwithout:\r\n```\r\nreal    0m58.913s\r\nreal    0m58.693s\r\nreal    0m59.070s\r\nreal    0m58.799s\r\n```\nWould you want to create a PR to remove it?\nYes, will do.\n\n",
  "base_commit": "06fafc4d023460c682494672b617d456037baf67",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/d1b73d13d9fb75005bf3c2eb176aff9818f7762b",
    "https://github.com/pylint-dev/astroid/commit/171c48bb80b66b0a6da3eb33d38a1ea8d612de52",
    "https://github.com/pylint-dev/astroid/commit/07719871e7ff8b113589cc26c464a862e20bb816",
    "https://github.com/pylint-dev/astroid/commit/370b630ec33fe5906cec6b38b271a4b06c5b9685",
    "https://github.com/pylint-dev/astroid/commit/38955bf992cd0dda6b95b8d48f282a3f0b4a42bb",
    "https://github.com/pylint-dev/astroid/commit/b923101f927bab865cddcdd51c9bb70cc9ce01cb",
    "https://github.com/pylint-dev/astroid/commit/04b07357371b7e8aa1de6d32064e1f411b314114",
    "https://github.com/pylint-dev/astroid/commit/d8a810fd85bb046c374637706f6e6e89f26c65b2",
    "https://github.com/pylint-dev/astroid/commit/cb5b291500f34743119fd4369ee458a2ac5aa7ce",
    "https://github.com/pylint-dev/astroid/commit/e054f407304aa3ad59b238c39583d3e960f075f7",
    "https://github.com/pylint-dev/astroid/commit/e7354389e1d2cc5ccb7822a5b59314e2bd71d23b",
    "https://github.com/pylint-dev/astroid/commit/0fa02331f73c080848c28291e338f60d94bf19fb",
    "https://github.com/pylint-dev/astroid/commit/30f249d0077e6963584785c08cfff341ad947dd5",
    "https://github.com/pylint-dev/astroid/commit/a79a2a74af4428bd5d4841b15f074b522ce4b969"
  ],
  "created_at": "2023-04-30T13:52:13Z",
  "hints_text": "Timing the pylint evaluation of checkers/ folder from pylint repo, I don't see a big difference with and without (explicit raise KeyError inserted) the cache:\r\nwith:\r\n```\r\nreal    0m57.994s\r\nreal    0m58.089s\r\nreal    0m57.446s\r\nreal    0m57.366s\r\n```\r\nwithout:\r\n```\r\nreal    0m58.913s\r\nreal    0m58.693s\r\nreal    0m59.070s\r\nreal    0m58.799s\r\n```\nWould you want to create a PR to remove it?\nYes, will do.\n\n",
  "instance_id": "pylint-dev__astroid-2158",
  "issue_numbers": [
    1828
  ],
  "language": "python",
  "patch": "diff --git a/ChangeLog b/ChangeLog\nindex a760172d10..faccda681d 100644\n--- a/ChangeLog\n+++ b/ChangeLog\n@@ -17,6 +17,13 @@ Release date: TBA\n \n * Reduce file system access in ``ast_from_file()``.\n \n+* Fix incorrect cache keys for inference results, thereby correctly inferring types\n+  for calls instantiating types dynamically.\n+\n+  Closes #1828\n+  Closes pylint-dev/pylint#7464\n+  Closes pylint-dev/pylint#8074\n+\n * ``nodes.FunctionDef`` no longer inherits from ``nodes.Lambda``.\n   This is a breaking change but considered a bug fix as the nodes did not share the same\n   API and were not interchangeable.\ndiff --git a/astroid/inference_tip.py b/astroid/inference_tip.py\nindex 5b855c9e77..92cb6b4fe1 100644\n--- a/astroid/inference_tip.py\n+++ b/astroid/inference_tip.py\n@@ -9,6 +9,7 @@\n import sys\n from collections.abc import Callable, Iterator\n \n+from astroid.context import InferenceContext\n from astroid.exceptions import InferenceOverwriteError, UseInferenceDefault\n from astroid.nodes import NodeNG\n from astroid.typing import InferenceResult, InferFn\n@@ -20,7 +21,11 @@\n \n _P = ParamSpec(\"_P\")\n \n-_cache: dict[tuple[InferFn, NodeNG], list[InferenceResult] | None] = {}\n+_cache: dict[\n+    tuple[InferFn, NodeNG, InferenceContext | None], list[InferenceResult]\n+] = {}\n+\n+_CURRENTLY_INFERRING: set[tuple[InferFn, NodeNG]] = set()\n \n \n def clear_inference_tip_cache() -> None:\n@@ -35,16 +40,25 @@ def _inference_tip_cached(\n \n     def inner(*args: _P.args, **kwargs: _P.kwargs) -> Iterator[InferenceResult]:\n         node = args[0]\n-        try:\n-            result = _cache[func, node]\n+        context = args[1]\n+        partial_cache_key = (func, node)\n+        if partial_cache_key in _CURRENTLY_INFERRING:\n             # If through recursion we end up trying to infer the same\n             # func + node we raise here.\n-            if result is None:\n-                raise UseInferenceDefault()\n+            raise UseInferenceDefault\n+        try:\n+            return _cache[func, node, context]\n         except KeyError:\n-            _cache[func, node] = None\n-            result = _cache[func, node] = list(func(*args, **kwargs))\n-            assert result\n+            # Recursion guard with a partial cache key.\n+            # Using the full key causes a recursion error on PyPy.\n+            # It's a pragmatic compromise to avoid so much recursive inference\n+            # with slightly different contexts while still passing the simple\n+            # test cases included with this commit.\n+            _CURRENTLY_INFERRING.add(partial_cache_key)\n+            result = _cache[func, node, context] = list(func(*args, **kwargs))\n+            # Remove recursion guard.\n+            _CURRENTLY_INFERRING.remove(partial_cache_key)\n+\n         return iter(result)\n \n     return inner\n",
  "problem_statement": "Wrong type inferred - inference type cache is missing context\nMoving discussion started in https://github.com/PyCQA/pylint/issues/7464 to astroid repo.\r\n\r\n### Steps to reproduce\r\n\r\n```\r\nimport astroid\r\n\r\nresult1, result2 = astroid.extract_node(\"\"\"\r\nclass Base:\r\n    def return_type(self):\r\n        return type(self)()\r\n\r\nclass A(Base):\r\n    def method(self):\r\n        return self.return_type()\r\n\r\nclass B(Base):\r\n    def method(self):\r\n        return self.return_type()\r\n\r\nA().method()  #@\r\nB().method()  #@\r\n\"\"\")\r\n\r\nprint(next(result1.infer()))\r\nprint(next(result2.infer()))\r\n```\r\n\r\n### Current behavior\r\nInstance of .A\r\nInstance of .A\r\n\r\n### Expected behavior\r\nInstance of .A\r\nInstance of .B\r\n\r\n### Workaround\r\nModify inference_tip.py to disable cache in _inference_tip_cached function. \r\n\r\n### `python -c \"from astroid import __pkginfo__; print(__pkginfo__.version)\"` output\r\n2.13.0-dev0\r\n\n",
  "pull_number": 2158,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/brain/test_brain.py b/tests/brain/test_brain.py\nindex 00a023ddb0..4a016868cb 100644\n--- a/tests/brain/test_brain.py\n+++ b/tests/brain/test_brain.py\n@@ -930,13 +930,7 @@ class A:\n         assert inferred.value == 42\n \n     def test_typing_cast_multiple_inference_calls(self) -> None:\n-        \"\"\"Inference of an outer function should not store the result for cast.\n-\n-        https://github.com/pylint-dev/pylint/issues/8074\n-\n-        Possible solution caused RecursionErrors with Python 3.8 and CPython + PyPy.\n-        https://github.com/pylint-dev/astroid/pull/1982\n-        \"\"\"\n+        \"\"\"Inference of an outer function should not store the result for cast.\"\"\"\n         ast_nodes = builder.extract_node(\n             \"\"\"\n         from typing import TypeVar, cast\n@@ -954,7 +948,7 @@ def ident(var: T) -> T:\n \n         i1 = next(ast_nodes[1].infer())\n         assert isinstance(i1, nodes.Const)\n-        assert i1.value == 2  # should be \"Hello\"!\n+        assert i1.value == \"Hello\"\n \n \n class ReBrainTest(unittest.TestCase):\ndiff --git a/tests/test_regrtest.py b/tests/test_regrtest.py\nindex 31d9e6b84b..59d344b954 100644\n--- a/tests/test_regrtest.py\n+++ b/tests/test_regrtest.py\n@@ -336,6 +336,27 @@ def d(self):\n         assert isinstance(inferred, Instance)\n         assert inferred.qname() == \".A\"\n \n+    def test_inference_context_consideration(self) -> None:\n+        \"\"\"https://github.com/PyCQA/astroid/issues/1828\"\"\"\n+        code = \"\"\"\n+        class Base:\n+            def return_type(self):\n+                return type(self)()\n+        class A(Base):\n+            def method(self):\n+                return self.return_type()\n+        class B(Base):\n+            def method(self):\n+                return self.return_type()\n+        A().method() #@\n+        B().method() #@\n+        \"\"\"\n+        node1, node2 = extract_node(code)\n+        inferred1 = next(node1.infer())\n+        assert inferred1.qname() == \".A\"\n+        inferred2 = next(node2.infer())\n+        assert inferred2.qname() == \".B\"\n+\n \n class Whatever:\n     a = property(lambda x: x, lambda x: x)  # type: ignore[misc]\ndiff --git a/tests/test_scoped_nodes.py b/tests/test_scoped_nodes.py\nindex b8c55f67d3..86d69624d1 100644\n--- a/tests/test_scoped_nodes.py\n+++ b/tests/test_scoped_nodes.py\n@@ -1771,9 +1771,7 @@ def __init__(self):\n                 \"FinalClass\",\n                 \"ClassB\",\n                 \"MixinB\",\n-                # We don't recognize what 'cls' is at time of .format() call, only\n-                # what it is at the end.\n-                # \"strMixin\",\n+                \"strMixin\",\n                 \"ClassA\",\n                 \"MixinA\",\n                 \"intMixin\",\n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/06fafc4d023460c682494672b617d456037baf67"
}