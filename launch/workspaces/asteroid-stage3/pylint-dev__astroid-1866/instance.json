{
  "all_hints_text": "Hi @crosser, thanks for the report.\r\n\r\n> I have no concise reproducer. \r\n\r\nWe might be able to help you distill one.\r\n\r\n`pylint` produces a crash report, and shows the link in your terminal, like this:\r\n```shell\r\n************* Module a\r\na.py:1:0: F0002: a.py: Fatal error while checking 'a.py'. Please open an issue in our bug tracker so we address this. There is a pre-filled template that you can use in '/Users/.../Library/Caches/pylint/pylint-crash-2022-10-29-08-48-25.txt'. (astroid-error)\r\n```\r\nThe offending file is at the top of the crash report. If the code is too long, or contains sensitive information, you can use the knowledge that the crash happened in `_infer_str_format_call` to look for calls to `.format()` on strings. You should be able to then just provide us those calls--and enough surrounding code to rebuild the objects you provided to `format()`. \r\n\r\nDoing this would be a tremendous help!\n> `pylint` produces a crash report, and shows the link in your terminal, like this:\r\n\r\nNo, not really, it does not. I am attaching a (censored) stderr from running the test. The line in the source code that apparently triggers the problem is pretty innocuous:\r\n\r\n```\r\n    @property\r\n    def vnet_id(self):  # <---- this is the line 266 that is mentioned in the \"Exception on node\" message\r\n        if ...:\r\n```\r\nThere is very similar property definition right before this one, that does not trigger the problem.\r\n\r\n[pyerr.txt](https://github.com/PyCQA/astroid/files/9900190/pyerr.txt)\r\n\r\nPylint command was `python3 -m pylint --jobs=0 --rcfile=test/style/pylint.conf <project-dir>`\r\n\r\n```\r\n$ pylint --version\r\npylint 2.15.5\r\nastroid 2.12.12\r\nPython 3.10.8 (main, Oct 24 2022, 10:07:16) [GCC 12.2.0]\r\n```\r\n\r\nedit:\r\n> enough surrounding code to rebuild the objects you provided to format().\r\n\r\n_I_ did not provide any objects to `format()`, astroid did...\nThanks for providing the traceback.\r\n\r\n> No, not really, it does not. I am attaching a (censored) stderr from running the test. \r\n\r\nI see now that it's because you're invoking pylint from a unittest, so your test is managing the output.\r\n\r\n> The line in the source code that apparently triggers the problem is pretty innocuous:\r\n\r\nThe deeper failure is on the call in line 268, not the function def on line 266. Is there anything you can sanitize and tell us about line 268? Thanks again for providing the help.\n> I see now that it's because you're invoking pylint from a unittest, so your test is managing the output.\r\n\r\nWhen I run pylint by hand\r\n\r\n```\r\npylint --jobs=0 --rcfile=test/style/pylint.conf <module-name> | tee /tmp/pyerr.txt\r\n```\r\nthere is still no \"Fatal error while checking ...\" message in the output\r\n\r\n> > The line in the source code that apparently triggers the problem is pretty innocuous:\r\n> \r\n> The deeper failure is on the call in line 268, not the function def on line 266. Is there anything you can sanitize and tell us about line 268? Thanks again for providing the help.\r\n\r\nOh yes, there is a `something.format()` in that line! But the \"something\" is a literal string:\r\n```\r\n    @property\r\n    def vnet_id(self):\r\n        if self.backend == \"something\":\r\n            return \"{:04x}{:04x}n{:d}\".format(  # <---- this is line 268\r\n                self.<some-attr>, self.<another-attr>, self.<third-attr>\r\n            )\r\n        if self.backend == \"somethingelse\":\r\n            return \"h{:08}n{:d}\".format(self.<more-attr>, self.<and more>)\r\n        return None\r\n```\r\n\nThanks, that was very helpful. Here is a reproducer:\r\n```python\r\nx = \"{:c}\".format(None)\r\n```\n\n",
  "base_commit": "6cf238d089cf4b6753c94cfc089b4a47487711e5",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/51690756956af66b9c61b447c2ccbf030c926ad1"
  ],
  "created_at": "2022-11-12T19:21:34Z",
  "hints_text": "Hi @crosser, thanks for the report.\r\n\r\n> I have no concise reproducer. \r\n\r\nWe might be able to help you distill one.\r\n\r\n`pylint` produces a crash report, and shows the link in your terminal, like this:\r\n```shell\r\n************* Module a\r\na.py:1:0: F0002: a.py: Fatal error while checking 'a.py'. Please open an issue in our bug tracker so we address this. There is a pre-filled template that you can use in '/Users/.../Library/Caches/pylint/pylint-crash-2022-10-29-08-48-25.txt'. (astroid-error)\r\n```\r\nThe offending file is at the top of the crash report. If the code is too long, or contains sensitive information, you can use the knowledge that the crash happened in `_infer_str_format_call` to look for calls to `.format()` on strings. You should be able to then just provide us those calls--and enough surrounding code to rebuild the objects you provided to `format()`. \r\n\r\nDoing this would be a tremendous help!\n> `pylint` produces a crash report, and shows the link in your terminal, like this:\r\n\r\nNo, not really, it does not. I am attaching a (censored) stderr from running the test. The line in the source code that apparently triggers the problem is pretty innocuous:\r\n\r\n```\r\n    @property\r\n    def vnet_id(self):  # <---- this is the line 266 that is mentioned in the \"Exception on node\" message\r\n        if ...:\r\n```\r\nThere is very similar property definition right before this one, that does not trigger the problem.\r\n\r\n[pyerr.txt](https://github.com/PyCQA/astroid/files/9900190/pyerr.txt)\r\n\r\nPylint command was `python3 -m pylint --jobs=0 --rcfile=test/style/pylint.conf <project-dir>`\r\n\r\n```\r\n$ pylint --version\r\npylint 2.15.5\r\nastroid 2.12.12\r\nPython 3.10.8 (main, Oct 24 2022, 10:07:16) [GCC 12.2.0]\r\n```\r\n\r\nedit:\r\n> enough surrounding code to rebuild the objects you provided to format().\r\n\r\n_I_ did not provide any objects to `format()`, astroid did...\nThanks for providing the traceback.\r\n\r\n> No, not really, it does not. I am attaching a (censored) stderr from running the test. \r\n\r\nI see now that it's because you're invoking pylint from a unittest, so your test is managing the output.\r\n\r\n> The line in the source code that apparently triggers the problem is pretty innocuous:\r\n\r\nThe deeper failure is on the call in line 268, not the function def on line 266. Is there anything you can sanitize and tell us about line 268? Thanks again for providing the help.\n> I see now that it's because you're invoking pylint from a unittest, so your test is managing the output.\r\n\r\nWhen I run pylint by hand\r\n\r\n```\r\npylint --jobs=0 --rcfile=test/style/pylint.conf <module-name> | tee /tmp/pyerr.txt\r\n```\r\nthere is still no \"Fatal error while checking ...\" message in the output\r\n\r\n> > The line in the source code that apparently triggers the problem is pretty innocuous:\r\n> \r\n> The deeper failure is on the call in line 268, not the function def on line 266. Is there anything you can sanitize and tell us about line 268? Thanks again for providing the help.\r\n\r\nOh yes, there is a `something.format()` in that line! But the \"something\" is a literal string:\r\n```\r\n    @property\r\n    def vnet_id(self):\r\n        if self.backend == \"something\":\r\n            return \"{:04x}{:04x}n{:d}\".format(  # <---- this is line 268\r\n                self.<some-attr>, self.<another-attr>, self.<third-attr>\r\n            )\r\n        if self.backend == \"somethingelse\":\r\n            return \"h{:08}n{:d}\".format(self.<more-attr>, self.<and more>)\r\n        return None\r\n```\r\n\n\n",
  "instance_id": "pylint-dev__astroid-1866",
  "issue_numbers": [
    1856
  ],
  "language": "python",
  "patch": "diff --git a/ChangeLog b/ChangeLog\nindex d1b64c71e2..89cd00f015 100644\n--- a/ChangeLog\n+++ b/ChangeLog\n@@ -29,6 +29,11 @@ Release date: TBA\n \n   Refs PyCQA/pylint#5099\n \n+* Prevent a crash when inferring calls to ``str.format`` with inferred arguments\n+  that would be invalid.\n+\n+  Closes #1856\n+\n * Infer the `length` argument of the ``random.sample`` function.\n \n   Refs PyCQA/pylint#7706\ndiff --git a/astroid/brain/brain_builtin_inference.py b/astroid/brain/brain_builtin_inference.py\nindex af1ddf4d23..e84f5bc024 100644\n--- a/astroid/brain/brain_builtin_inference.py\n+++ b/astroid/brain/brain_builtin_inference.py\n@@ -954,8 +954,10 @@ def _infer_str_format_call(\n \n     try:\n         formatted_string = format_template.format(*pos_values, **keyword_values)\n-    except (IndexError, KeyError):\n-        # If there is an IndexError there are too few arguments to interpolate\n+    except (IndexError, KeyError, TypeError, ValueError):\n+        # IndexError: there are too few arguments to interpolate\n+        # TypeError: Unsupported format string\n+        # ValueError: Unknown format code\n         return iter([util.Uninferable])\n \n     return iter([nodes.const_factory(formatted_string)])\n",
  "problem_statement": "\"TypeError: unsupported format string passed to NoneType.__format__\" while running type inference in version 2.12.x\n### Steps to reproduce\r\n\r\nI have no concise reproducer. Exception happens every time I run pylint on some internal code, with astroid 2.12.10 and 2.12.12 (debian bookworm). It does _not_ happen with earlier versions of astroid (not with version 2.9). The pylinted code itself is \"valid\", it runs in production here.\r\n\r\n### Current behavior\r\n\r\nWhen running pylint on some code, I get this exception:\r\n```\r\nTraceback (most recent call last):\r\n  File \"/usr/lib/python3/dist-packages/pylint/utils/ast_walker.py\", line 90, in walk\r\n    callback(astroid)\r\n  File \"/usr/lib/python3/dist-packages/pylint/checkers/classes/special_methods_checker.py\", line 183, in visit_functiondef\r\n    inferred = _safe_infer_call_result(node, node)\r\n  File \"/usr/lib/python3/dist-packages/pylint/checkers/classes/special_methods_checker.py\", line 42, in _safe_infer_call_result\r\n    value = next(inferit)\r\n  File \"/usr/lib/python3/dist-packages/astroid/nodes/scoped_nodes/scoped_nodes.py\", line 1749, in infer_call_result\r\n    yield from returnnode.value.infer(context)\r\n  File \"/usr/lib/python3/dist-packages/astroid/nodes/node_ng.py\", line 159, in infer\r\n    results = list(self._explicit_inference(self, context, **kwargs))\r\n  File \"/usr/lib/python3/dist-packages/astroid/inference_tip.py\", line 45, in _inference_tip_cached\r\n    result = _cache[func, node] = list(func(*args, **kwargs))\r\n  File \"/usr/lib/python3/dist-packages/astroid/brain/brain_builtin_inference.py\", line 956, in _infer_str_format_call\r\n    formatted_string = format_template.format(*pos_values, **keyword_values)\r\nTypeError: unsupported format string passed to NoneType.__format__\r\n```\r\n\r\n### Expected behavior\r\n\r\nTypeError exception should not happen\r\n\r\n### `python -c \"from astroid import __pkginfo__; print(__pkginfo__.version)\"` output\r\n\r\n2.12.10,\r\n2.12.12\n",
  "pull_number": 1866,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/unittest_brain_builtin.py b/tests/unittest_brain_builtin.py\nindex dd99444b1f..6f7038fb99 100644\n--- a/tests/unittest_brain_builtin.py\n+++ b/tests/unittest_brain_builtin.py\n@@ -103,6 +103,12 @@ def test_string_format(self, format_string: str) -> None:\n             \"\"\"\n             \"My name is {fname}, I'm {age}\".format(fsname = \"Daniel\", age = 12)\n             \"\"\",\n+            \"\"\"\n+            \"My unicode character is {:c}\".format(None)\n+            \"\"\",\n+            \"\"\"\n+            \"My hex format is {:4x}\".format('1')\n+            \"\"\",\n         ],\n     )\n     def test_string_format_uninferable(self, format_string: str) -> None:\n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/6cf238d089cf4b6753c94cfc089b4a47487711e5"
}