{
  "all_hints_text": "Actually, it seems a decorator is a red herring here, because I get the same off by one issue simply parsing a call\r\n\r\n```python\r\nsource = \"\"\"\\\r\nf(a=2,\r\n   b=3,\r\n)\r\n\"\"\"\r\n\r\n[call] = ast.parse(source).body\r\nprint(\"ast\", call.lineno, call.end_lineno)\r\n\r\n[call] = astroid.parse(source).body\r\nprint(\"astroid\", call.fromlineno, call.tolineno)\r\n```\r\n\r\nwhich outputs\r\n\r\n```\r\nast 1 3\r\nastroid 1 2\r\n```\nOkay, this seems to be caused by the implementation of `NodeNG.tolineno` which uses the last line of the *child* to approximate the last line of the parent:\r\n\r\nhttps://github.com/PyCQA/astroid/blob/03efcc3f86b88bab3080fe69119ee4c69e4afd0a/astroid/nodes/node_ng.py#L437-L446\r\n\r\nOnce possible fix is to override `tolineno` in `Call`. Wdyt?\n> this seems to be caused by the implementation of NodeNG.tolineno which uses the last line of the child to approximate the last line of the parent:\r\n\r\nNaive question, would it be possible to use the last line of the node instead, directly in NodeNG ?\nYeah, I think that should work with a caveat that the `ast` module only reports end line/column since Python 3.8. I'll draft a PR.\n@superbobry I was looking at `tolineno` recently. I was wondering if it would make sense to add a check for >= 3.8 and then just use the `end_lineno` attribute that was added recently. No need to reinvent the wheel on those versions.\r\n\r\nPerhaps that's a bit out of the scope of the PR you were going to draft, but it might help!\n@DanielNoord I was actually thinking of doing almost exactly that. Interestingly, this change seems to break block range computation in `TryFinally` (and possibly other node classes).\r\n\r\nSee https://github.com/PyCQA/astroid/runs/4822279617.\n\n",
  "base_commit": "cfd9e74f7b4cbac08357cadec03c736501368afa",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/b1e0db2ab2b81e303fdccbef44280b42747334e7",
    "https://github.com/pylint-dev/astroid/commit/15a5bf0ee51b3707e79a42b6427ae6abc80ccf89",
    "https://github.com/pylint-dev/astroid/commit/adbc4d48941967078a6100ad63953d5af9da2fa0",
    "https://github.com/pylint-dev/astroid/commit/2a16e64e2b5798bc5d966a89a64c12ec26d73305",
    "https://github.com/pylint-dev/astroid/commit/caf1916b9052d59280a8e50dc99ce34011924caa",
    "https://github.com/pylint-dev/astroid/commit/fd3a6a89a29ff8f12289f7870a769433b3a4c81f"
  ],
  "created_at": "2022-01-14T21:14:48Z",
  "hints_text": "\n\n",
  "instance_id": "pylint-dev__astroid-1351",
  "issue_numbers": [
    1350
  ],
  "language": "python",
  "patch": "diff --git a/ChangeLog b/ChangeLog\nindex bce6094b46..e206228968 100644\n--- a/ChangeLog\n+++ b/ChangeLog\n@@ -30,6 +30,11 @@ Release date: TBA\n \n   Closes #1330\n \n+* Use the ``end_lineno`` attribute for the ``NodeNG.tolineno`` property\n+  when it is available.\n+\n+  Closes #1350\n+\n * Add ``is_dataclass`` attribute to ``ClassDef`` nodes.\n \n * Use ``sysconfig`` instead of ``distutils`` to determine the location of\ndiff --git a/astroid/nodes/node_ng.py b/astroid/nodes/node_ng.py\nindex 4688876f50..5a12925deb 100644\n--- a/astroid/nodes/node_ng.py\n+++ b/astroid/nodes/node_ng.py\n@@ -438,6 +438,8 @@ def fromlineno(self) -> Optional[int]:\n     @decorators.cachedproperty\n     def tolineno(self) -> Optional[int]:\n         \"\"\"The last line that this node appears on in the source code.\"\"\"\n+        if self.end_lineno is not None:\n+            return self.end_lineno\n         if not self._astroid_fields:\n             # can't have children\n             last_child = None\ndiff --git a/astroid/rebuilder.py b/astroid/rebuilder.py\nindex 13b007026c..94043f7ba1 100644\n--- a/astroid/rebuilder.py\n+++ b/astroid/rebuilder.py\n@@ -2125,11 +2125,21 @@ def visit_starred(self, node: \"ast.Starred\", parent: NodeNG) -> nodes.Starred:\n     def visit_tryexcept(self, node: \"ast.Try\", parent: NodeNG) -> nodes.TryExcept:\n         \"\"\"visit a TryExcept node by returning a fresh instance of it\"\"\"\n         if sys.version_info >= (3, 8):\n+            # TryExcept excludes the 'finally' but that will be included in the\n+            # end_lineno from 'node'. Therefore, we check all non 'finally'\n+            # children to find the correct end_lineno and column.\n+            end_lineno = node.end_lineno\n+            end_col_offset = node.end_col_offset\n+            all_children: List[\"ast.AST\"] = [*node.body, *node.handlers, *node.orelse]\n+            for child in reversed(all_children):\n+                end_lineno = child.end_lineno\n+                end_col_offset = child.end_col_offset\n+                break\n             newnode = nodes.TryExcept(\n                 lineno=node.lineno,\n                 col_offset=node.col_offset,\n-                end_lineno=node.end_lineno,\n-                end_col_offset=node.end_col_offset,\n+                end_lineno=end_lineno,\n+                end_col_offset=end_col_offset,\n                 parent=parent,\n             )\n         else:\n",
  "problem_statement": "Decorator.toline is off by 1\n### Steps to reproduce\r\n\r\nI came across this inconsistency while debugging why pylint reports `missing-docstring` on the wrong line for the `g2` function in the example. As it turns out, the `toline` of the decorator seems to point to `b=3,` instead of `)`.\r\n\r\n```python\r\nimport ast\r\nimport astroid\r\n\r\nsource = \"\"\"\\\r\n@f(a=2,\r\n   b=3,\r\n)\r\ndef g2():\r\n    pass\r\n\"\"\"\r\n\r\n[f] = ast.parse(source).body\r\n[deco] = f.decorator_list\r\nprint(\"ast\", deco.lineno, deco.end_lineno)\r\n\r\n[f] = astroid.parse(source).body\r\n[deco] = f.decorators.nodes\r\nprint(\"astroid\", deco.fromlineno, deco.tolineno)\r\n```\r\n\r\n### Current behavior\r\n\r\n```\r\nast 1 3\r\nastroid 1 2\r\n```\r\n\r\n### Expected behavior\r\n\r\n```\r\nast 1 3\r\nastroid 1 3\r\n```\r\n\r\n### `python -c \"from astroid import __pkginfo__; print(__pkginfo__.version)\"` output\r\n\r\n2.9.3\n",
  "pull_number": 1351,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/unittest_builder.py b/tests/unittest_builder.py\nindex eb7fbdc77f..fbcf413174 100644\n--- a/tests/unittest_builder.py\n+++ b/tests/unittest_builder.py\n@@ -71,11 +71,14 @@ def test_callfunc_lineno(self) -> None:\n         strarg = callfunc.args[0]\n         self.assertIsInstance(strarg, nodes.Const)\n         if hasattr(sys, \"pypy_version_info\"):\n-            lineno = 4\n+            self.assertEqual(strarg.fromlineno, 4)\n+            self.assertEqual(strarg.tolineno, 4)\n         else:\n-            lineno = 5 if not PY38_PLUS else 4\n-        self.assertEqual(strarg.fromlineno, lineno)\n-        self.assertEqual(strarg.tolineno, lineno)\n+            if not PY38_PLUS:\n+                self.assertEqual(strarg.fromlineno, 5)\n+            else:\n+                self.assertEqual(strarg.fromlineno, 4)\n+            self.assertEqual(strarg.tolineno, 5)\n         namearg = callfunc.args[1]\n         self.assertIsInstance(namearg, nodes.Name)\n         self.assertEqual(namearg.fromlineno, 5)\ndiff --git a/tests/unittest_nodes_lineno.py b/tests/unittest_nodes_lineno.py\nindex 73cf0207cc..0f1b7e4ac7 100644\n--- a/tests/unittest_nodes_lineno.py\n+++ b/tests/unittest_nodes_lineno.py\n@@ -784,7 +784,7 @@ def test_end_lineno_try() -> None:\n         assert (t3.lineno, t3.col_offset) == (10, 0)\n         assert (t3.end_lineno, t3.end_col_offset) == (17, 8)\n         assert (t3.body[0].lineno, t3.body[0].col_offset) == (10, 0)\n-        assert (t3.body[0].end_lineno, t3.body[0].end_col_offset) == (17, 8)\n+        assert (t3.body[0].end_lineno, t3.body[0].end_col_offset) == (15, 8)\n         assert (t3.finalbody[0].lineno, t3.finalbody[0].col_offset) == (17, 4)\n         assert (t3.finalbody[0].end_lineno, t3.finalbody[0].end_col_offset) == (17, 8)\n \ndiff --git a/tests/unittest_scoped_nodes.py b/tests/unittest_scoped_nodes.py\nindex 9b2bc291a6..0009278d75 100644\n--- a/tests/unittest_scoped_nodes.py\n+++ b/tests/unittest_scoped_nodes.py\n@@ -1092,15 +1092,19 @@ def g1(x):\n                 print(x)\n \n             @f(a=2,\n-               b=3)\n+               b=3,\n+            )\n             def g2():\n                 pass\n         \"\"\"\n         astroid = builder.parse(data)\n         self.assertEqual(astroid[\"g1\"].fromlineno, 4)\n         self.assertEqual(astroid[\"g1\"].tolineno, 5)\n-        self.assertEqual(astroid[\"g2\"].fromlineno, 9)\n-        self.assertEqual(astroid[\"g2\"].tolineno, 10)\n+        if not PY38_PLUS:\n+            self.assertEqual(astroid[\"g2\"].fromlineno, 9)\n+        else:\n+            self.assertEqual(astroid[\"g2\"].fromlineno, 10)\n+        self.assertEqual(astroid[\"g2\"].tolineno, 11)\n \n     def test_metaclass_error(self) -> None:\n         astroid = builder.parse(\n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/cfd9e74f7b4cbac08357cadec03c736501368afa"
}