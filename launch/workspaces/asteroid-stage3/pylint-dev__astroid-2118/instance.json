{
  "all_hints_text": "This seems relevant:\r\n\r\nhttps://github.com/PyCQA/astroid/blob/1a698acd4ca746851e6a525bf7e012ac6e6eb877/astroid/nodes/scoped_nodes/scoped_nodes.py#L1702-L1712\r\n\r\nI am not familiar with that code, but it seems like this is indeed very error-prone.\n@DanielNoord \r\n\r\nhttps://github.com/PyCQA/astroid/blob/1a698acd4ca746851e6a525bf7e012ac6e6eb877/astroid/nodes/scoped_nodes/scoped_nodes.py#L1713\r\n\r\nI think this line is the exact problem. Did `FunctionDef.args` ever return a list of nodes before? It seems to return an `Arguments` type now.\nNot as far as I know. However, is `caller` always a `FunctionDef`? Might that be where this is going wrong?\n@DanielNoord do you know of any node type which has an `args` field of type list?\n`CallContext` has `list[NodeNG]` and `Arguments` has `list[AssignName]`.\nIt looks like this is happening whether or not `six` is involved, but yes, since #1622 we no longer inject a `Call` as a fake base. That fake `Call` would have had `.args`.\n\n",
  "base_commit": "495581f0ff1b0513397b9177c62f27e702e11bb2",
  "commit_urls": [
    "https://github.com/pylint-dev/astroid/commit/4b31a4bdbde019bf26fa7751172d5541530d2982",
    "https://github.com/pylint-dev/astroid/commit/15722e60a1180d1d766d8daa6711b87fafbc0674",
    "https://github.com/pylint-dev/astroid/commit/65b09d5d9242277ec55df957eeaca6112de783ac"
  ],
  "created_at": "2023-04-15T14:52:11Z",
  "hints_text": "This seems relevant:\r\n\r\nhttps://github.com/PyCQA/astroid/blob/1a698acd4ca746851e6a525bf7e012ac6e6eb877/astroid/nodes/scoped_nodes/scoped_nodes.py#L1702-L1712\r\n\r\nI am not familiar with that code, but it seems like this is indeed very error-prone.\n@DanielNoord \r\n\r\nhttps://github.com/PyCQA/astroid/blob/1a698acd4ca746851e6a525bf7e012ac6e6eb877/astroid/nodes/scoped_nodes/scoped_nodes.py#L1713\r\n\r\nI think this line is the exact problem. Did `FunctionDef.args` ever return a list of nodes before? It seems to return an `Arguments` type now.\nNot as far as I know. However, is `caller` always a `FunctionDef`? Might that be where this is going wrong?\n@DanielNoord do you know of any node type which has an `args` field of type list?\n`CallContext` has `list[NodeNG]` and `Arguments` has `list[AssignName]`.\nIt looks like this is happening whether or not `six` is involved, but yes, since #1622 we no longer inject a `Call` as a fake base. That fake `Call` would have had `.args`.\n\n",
  "instance_id": "pylint-dev__astroid-2118",
  "issue_numbers": [
    1735
  ],
  "language": "python",
  "patch": "diff --git a/ChangeLog b/ChangeLog\nindex 460ef30507..f02a58516c 100644\n--- a/ChangeLog\n+++ b/ChangeLog\n@@ -61,6 +61,9 @@ What's New in astroid 2.15.3?\n =============================\n Release date: TBA\n \n+* Fix ``infer_call_result()`` crash on methods called ``with_metaclass()``.\n+\n+  Closes #1735\n \n \n What's New in astroid 2.15.2?\ndiff --git a/astroid/nodes/scoped_nodes/scoped_nodes.py b/astroid/nodes/scoped_nodes/scoped_nodes.py\nindex c75237729d..8c39129c28 100644\n--- a/astroid/nodes/scoped_nodes/scoped_nodes.py\n+++ b/astroid/nodes/scoped_nodes/scoped_nodes.py\n@@ -1692,10 +1692,18 @@ def infer_call_result(self, caller=None, context: InferenceContext | None = None\n         # generators, and filter it out later.\n         if (\n             self.name == \"with_metaclass\"\n+            and caller is not None\n             and len(self.args.args) == 1\n             and self.args.vararg is not None\n         ):\n-            metaclass = next(caller.args[0].infer(context), None)\n+            if isinstance(caller.args, Arguments):\n+                metaclass = next(caller.args.args[0].infer(context), None)\n+            elif isinstance(caller.args, list):\n+                metaclass = next(caller.args[0].infer(context), None)\n+            else:\n+                raise TypeError(  # pragma: no cover\n+                    f\"caller.args was neither Arguments nor list; got {type(caller.args)}\"\n+                )\n             if isinstance(metaclass, ClassDef):\n                 try:\n                     class_bases = [\n",
  "problem_statement": "Code for supporting `with_metaclass` seems broken\nSo this code works as expected:\r\n```python\r\nnode = astroid.extract_node('''\r\ndef foo():\r\n    return 42\r\n''')\r\nprint(list(node.infer_call_result(caller=node)))\r\n```\r\n```console\r\n$ python a.py\r\n[<Const.int l.3 at 0x105704070>]\r\n```\r\n\r\nBut this breaks:\r\n```python\r\nnode = astroid.extract_node('''\r\ndef with_metaclass(meta, *bases):\r\n    return 42\r\n''')\r\nprint(list(node.infer_call_result(caller=node)))\r\n```\r\n\r\n```console\r\n$ python a.py\r\nTraceback (most recent call last):\r\n  File \"/Users/tusharsadhwani/a.py\", line 14, in <module>\r\n    print(list(node.infer_call_result(node)))\r\n  File \"/Users/tusharsadhwani/venv/lib/python3.10/site-packages/astroid/nodes/scoped_nodes/scoped_nodes.py\", line 1738, in infer_call_result\r\n    metaclass = next(caller.args[0].infer(context), None)\r\nTypeError: 'Arguments' object is not subscriptable\r\n```\r\nastroid seems to have special handling for functions called `with_metaclass`, which seems to be broken.\r\n\r\nAm I using the method wrongly? I tried using it just as I saw it being used in the project itself.\n",
  "pull_number": 2118,
  "repo": "pylint-dev/astroid",
  "test_patch": "diff --git a/tests/test_inference.py b/tests/test_inference.py\nindex 37a48f089d..7fcbb10cce 100644\n--- a/tests/test_inference.py\n+++ b/tests/test_inference.py\n@@ -4055,6 +4055,11 @@ class C:\n             inferred = next(node.infer())\n             self.assertRaises(InferenceError, next, inferred.infer_call_result(node))\n \n+    def test_infer_call_result_with_metaclass(self) -> None:\n+        node = extract_node(\"def with_metaclass(meta, *bases): return 42\")\n+        inferred = next(node.infer_call_result(caller=node))\n+        self.assertIsInstance(inferred, nodes.Const)\n+\n     def test_context_call_for_context_managers(self) -> None:\n         ast_nodes = extract_node(\n             \"\"\"\n",
  "commit_url": "https://github.com/pylint-dev/astroid/tree/495581f0ff1b0513397b9177c62f27e702e11bb2"
}